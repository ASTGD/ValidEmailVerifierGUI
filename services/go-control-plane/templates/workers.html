{{ define "workers" }}
<section class="rounded-2xl border border-slate-800 bg-slate-900/60 p-6">
    <div class="flex items-center justify-between">
        <div>
            <h2 class="text-lg font-semibold">Workers</h2>
            <p class="text-sm text-slate-400">Manage worker state with safe actions.</p>
        </div>
        <span id="workers-active-count" class="text-xs text-slate-400">{{ .WorkerCount }} active</span>
    </div>

    <div class="mt-6 overflow-x-auto">
        <table class="w-full text-left text-sm">
            <thead class="text-xs uppercase text-slate-500">
                <tr>
                    <th class="py-2">Worker</th>
                    <th class="py-2">Host</th>
                    <th class="py-2">Pool</th>
                    <th class="py-2">Status</th>
                    <th class="py-2">Desired</th>
                    <th class="py-2">Quarantine</th>
                    <th class="py-2">Last Heartbeat</th>
                    <th class="py-2">Actions</th>
                </tr>
            </thead>
            <tbody id="workers-table-body" class="divide-y divide-slate-800">
                {{ range .Workers }}
                <tr>
                    <td class="py-3 font-medium">{{ .WorkerID }}</td>
                    <td class="py-3 text-slate-300">{{ .Host }}</td>
                    <td class="py-3 text-slate-300">{{ if .Pool }}{{ .Pool }}{{ else }}-{{ end }}</td>
                    <td class="py-3">
                        <span class="rounded-full bg-slate-800 px-3 py-1 text-xs">{{ .Status }}</span>
                    </td>
                    <td class="py-3">
                        <span class="rounded-full bg-amber-500/20 px-3 py-1 text-xs text-amber-300">{{ .DesiredState }}</span>
                    </td>
                    <td class="py-3">
                        <span class="rounded-full px-3 py-1 text-xs {{ if .Quarantined }}bg-red-500/20 text-red-300{{ else }}bg-emerald-500/20 text-emerald-300{{ end }}">{{ if .Quarantined }}on{{ else }}off{{ end }}</span>
                    </td>
                    <td class="py-3 text-slate-400">{{ .LastHeartbeat }}</td>
                    <td class="py-3">
                        <div class="flex flex-wrap gap-2">
                            <form method="POST" action="{{ $.BasePath }}/workers/{{ .WorkerID }}/pause">
                                <button class="rounded-full bg-slate-800 px-3 py-1 text-xs text-slate-200 hover:bg-slate-700" type="submit">Pause</button>
                            </form>
                            <form method="POST" action="{{ $.BasePath }}/workers/{{ .WorkerID }}/resume">
                                <button class="rounded-full bg-slate-800 px-3 py-1 text-xs text-slate-200 hover:bg-slate-700" type="submit">Resume</button>
                            </form>
                            <form method="POST" action="{{ $.BasePath }}/workers/{{ .WorkerID }}/drain">
                                <button class="rounded-full bg-amber-500/20 px-3 py-1 text-xs text-amber-300 hover:bg-amber-500/30" type="submit">Drain</button>
                            </form>
                            <form method="POST" action="{{ $.BasePath }}/workers/{{ .WorkerID }}/stop">
                                <button class="rounded-full bg-red-500/20 px-3 py-1 text-xs text-red-300 hover:bg-red-500/30" type="submit">Stop</button>
                            </form>
                            {{ if .Quarantined }}
                            <form method="POST" action="{{ $.BasePath }}/workers/{{ .WorkerID }}/unquarantine">
                                <button class="rounded-full bg-emerald-500/20 px-3 py-1 text-xs text-emerald-300 hover:bg-emerald-500/30" type="submit">Unquarantine</button>
                            </form>
                            {{ else }}
                            <form method="POST" action="{{ $.BasePath }}/workers/{{ .WorkerID }}/quarantine">
                                <button class="rounded-full bg-red-500/20 px-3 py-1 text-xs text-red-300 hover:bg-red-500/30" type="submit">Quarantine</button>
                            </form>
                            {{ end }}
                        </div>
                    </td>
                </tr>
                {{ else }}
                <tr>
                    <td class="py-6 text-center text-slate-400" colspan="8">No active workers yet.</td>
                </tr>
                {{ end }}
            </tbody>
        </table>
    </div>
</section>

<script defer>
    window.addEventListener('DOMContentLoaded', () => {
        const tbody = document.getElementById('workers-table-body');
        const activeCount = document.getElementById('workers-active-count');
        const pollIntervalSeconds = Math.max(2, Number({{ .PollIntervalSeconds }}) || 10);
        const pollIntervalMs = pollIntervalSeconds * 1000;
        if (!tbody) {
            return;
        }

        const basePath = '{{ .BasePath }}';
        const escapeHtml = (value) => String(value ?? '')
            .replaceAll('&', '&amp;')
            .replaceAll('<', '&lt;')
            .replaceAll('>', '&gt;')
            .replaceAll('"', '&quot;')
            .replaceAll("'", '&#39;');

        const actionButton = (action, label, classes) => `
            <form method="POST" action="${basePath}/workers/${encodeURIComponent(action.workerID)}/${action.name}">
                <button class="${classes}" type="submit">${label}</button>
            </form>
        `;

        const renderActions = (workerID, quarantined) => {
            const base = [
                actionButton({ workerID, name: 'pause' }, 'Pause', 'rounded-full bg-slate-800 px-3 py-1 text-xs text-slate-200 hover:bg-slate-700'),
                actionButton({ workerID, name: 'resume' }, 'Resume', 'rounded-full bg-slate-800 px-3 py-1 text-xs text-slate-200 hover:bg-slate-700'),
                actionButton({ workerID, name: 'drain' }, 'Drain', 'rounded-full bg-amber-500/20 px-3 py-1 text-xs text-amber-300 hover:bg-amber-500/30'),
                actionButton({ workerID, name: 'stop' }, 'Stop', 'rounded-full bg-red-500/20 px-3 py-1 text-xs text-red-300 hover:bg-red-500/30'),
            ];
            if (quarantined) {
                base.push(actionButton({ workerID, name: 'unquarantine' }, 'Unquarantine', 'rounded-full bg-emerald-500/20 px-3 py-1 text-xs text-emerald-300 hover:bg-emerald-500/30'));
            } else {
                base.push(actionButton({ workerID, name: 'quarantine' }, 'Quarantine', 'rounded-full bg-red-500/20 px-3 py-1 text-xs text-red-300 hover:bg-red-500/30'));
            }

            return `<div class="flex flex-wrap gap-2">${base.join('')}</div>`;
        };

        const renderWorkers = (workers) => {
            if (!Array.isArray(workers) || workers.length === 0) {
                tbody.innerHTML = '<tr><td class="py-6 text-center text-slate-400" colspan="8">No active workers yet.</td></tr>';
                if (activeCount) {
                    activeCount.textContent = '0 active';
                }
                return;
            }

            const rows = workers.map((worker) => {
                const rawWorkerID = String(worker.worker_id || '');
                const workerID = escapeHtml(rawWorkerID);
                const host = escapeHtml(worker.host || '');
                const pool = escapeHtml(worker.pool || '-');
                const status = escapeHtml(worker.status || 'unknown');
                const desired = escapeHtml(worker.desired_state || 'running');
                const heartbeat = escapeHtml(worker.last_heartbeat_at || '-');
                const quarantined = Boolean(worker.quarantined);
                const quarantineClass = quarantined ? 'bg-red-500/20 text-red-300' : 'bg-emerald-500/20 text-emerald-300';
                const quarantineText = quarantined ? 'on' : 'off';

                return `
                    <tr>
                        <td class="py-3 font-medium">${workerID}</td>
                        <td class="py-3 text-slate-300">${host || '-'}</td>
                        <td class="py-3 text-slate-300">${pool}</td>
                        <td class="py-3"><span class="rounded-full bg-slate-800 px-3 py-1 text-xs">${status}</span></td>
                        <td class="py-3"><span class="rounded-full bg-amber-500/20 px-3 py-1 text-xs text-amber-300">${desired}</span></td>
                        <td class="py-3"><span class="rounded-full px-3 py-1 text-xs ${quarantineClass}">${quarantineText}</span></td>
                        <td class="py-3 text-slate-400">${heartbeat}</td>
                        <td class="py-3">${renderActions(rawWorkerID, quarantined)}</td>
                    </tr>
                `;
            });

            tbody.innerHTML = rows.join('');
            if (activeCount) {
                activeCount.textContent = `${workers.length} active`;
            }
        };

        const refreshWorkers = async () => {
            try {
                const response = await fetch('/api/workers', { headers: { 'Accept': 'application/json' } });
                if (!response.ok) {
                    return;
                }

                const payload = await response.json();
                renderWorkers(payload.data);
            } catch (_) {}
        };

        refreshWorkers();
        const intervalId = window.setInterval(refreshWorkers, pollIntervalMs);
        window.addEventListener('beforeunload', () => window.clearInterval(intervalId));
    });
</script>
{{ end }}
