{{ define "settings" }}
<section class="rounded-2xl border border-slate-800 bg-slate-900/60 p-6">
        <div class="flex items-center justify-between">
        <div>
            <h2 class="text-lg font-semibold">Runtime Safety Settings</h2>
            <p class="text-sm text-slate-400">Saved in Redis. Alerting, quarantine, and autoscale controls are hot-reloaded.</p>
        </div>
    </div>

    {{ if .Saved }}
    <div class="mt-4 rounded-xl border border-emerald-500/30 bg-emerald-500/10 p-4 text-sm text-emerald-200">
        Settings saved.
    </div>
    {{ end }}

    <form method="POST" action="{{ .BasePath }}/settings" class="mt-6 space-y-5">
        <div class="grid gap-4 md:grid-cols-3">
            <label class="flex items-center gap-3 rounded-xl border border-slate-800 bg-slate-950/60 p-4">
                <input type="checkbox" name="alerts_enabled" {{ if .Settings.AlertsEnabled }}checked{{ end }} class="h-4 w-4 rounded border-slate-600 bg-slate-900 text-amber-500 focus:ring-amber-500" />
                <span>
                    <span class="block text-sm font-medium">Enable alerts</span>
                    <span class="block text-xs text-slate-400">Turns alert checks and notifications on.</span>
                </span>
            </label>

            <label class="flex items-center gap-3 rounded-xl border border-slate-800 bg-slate-950/60 p-4">
                <input type="checkbox" name="auto_actions_enabled" {{ if .Settings.AutoActionsEnabled }}checked{{ end }} class="h-4 w-4 rounded border-slate-600 bg-slate-900 text-amber-500 focus:ring-amber-500" />
                <span>
                    <span class="block text-sm font-medium">Enable auto actions</span>
                    <span class="block text-xs text-slate-400">Drains workers that exceed the error-rate threshold.</span>
                </span>
            </label>

            <label class="flex items-center gap-3 rounded-xl border border-slate-800 bg-slate-950/60 p-4">
                <input type="checkbox" name="autoscale_enabled" {{ if .Settings.AutoscaleEnabled }}checked{{ end }} class="h-4 w-4 rounded border-slate-600 bg-slate-900 text-amber-500 focus:ring-amber-500" />
                <span>
                    <span class="block text-sm font-medium">Enable autoscaling</span>
                    <span class="block text-xs text-slate-400">Allows control plane to adjust pool desired counts within safe limits.</span>
                </span>
            </label>

            <label class="flex items-center gap-3 rounded-xl border border-slate-800 bg-slate-950/60 p-4">
                <input type="checkbox" name="provider_policy_engine_enabled" {{ if .Settings.ProviderPolicyEngineEnabled }}checked{{ end }} class="h-4 w-4 rounded border-slate-600 bg-slate-900 text-amber-500 focus:ring-amber-500" />
                <span>
                    <span class="block text-sm font-medium">Enable provider policy engine</span>
                    <span class="block text-xs text-slate-400">Turns on provider-level policy behavior for SMTP control logic.</span>
                </span>
            </label>

            <label class="flex items-center gap-3 rounded-xl border border-slate-800 bg-slate-950/60 p-4">
                <input type="checkbox" name="adaptive_retry_enabled" {{ if .Settings.AdaptiveRetryEnabled }}checked{{ end }} class="h-4 w-4 rounded border-slate-600 bg-slate-900 text-amber-500 focus:ring-amber-500" />
                <span>
                    <span class="block text-sm font-medium">Enable adaptive retry</span>
                    <span class="block text-xs text-slate-400">Uses provider-aware retry pacing for tempfail/greylist patterns.</span>
                </span>
            </label>

            <label class="flex items-center gap-3 rounded-xl border border-slate-800 bg-slate-950/60 p-4">
                <input type="checkbox" name="provider_autoprotect_enabled" {{ if .Settings.ProviderAutoprotectEnabled }}checked{{ end }} class="h-4 w-4 rounded border-slate-600 bg-slate-900 text-amber-500 focus:ring-amber-500" />
                <span>
                    <span class="block text-sm font-medium">Enable provider auto protect</span>
                    <span class="block text-xs text-slate-400">Auto-shifts provider mode when health degrades (respects manual overrides).</span>
                </span>
            </label>
        </div>

        <div class="grid gap-4 md:grid-cols-3">
            <label class="space-y-2">
                <span class="text-xs uppercase tracking-wider text-slate-400">Error threshold (errors/min)</span>
                <input name="alert_error_rate_threshold" type="number" min="0" step="0.1" value="{{ .Settings.AlertErrorRateThreshold }}" class="w-full rounded-lg border border-slate-700 bg-slate-900 px-3 py-2 text-sm text-slate-100" />
            </label>

            <label class="space-y-2">
                <span class="text-xs uppercase tracking-wider text-slate-400">Heartbeat grace (seconds)</span>
                <input name="alert_heartbeat_grace_seconds" type="number" min="1" value="{{ .Settings.AlertHeartbeatGraceSecond }}" class="w-full rounded-lg border border-slate-700 bg-slate-900 px-3 py-2 text-sm text-slate-100" />
            </label>

            <label class="space-y-2">
                <span class="text-xs uppercase tracking-wider text-slate-400">Alert cooldown (seconds)</span>
                <input name="alert_cooldown_seconds" type="number" min="1" value="{{ .Settings.AlertCooldownSecond }}" class="w-full rounded-lg border border-slate-700 bg-slate-900 px-3 py-2 text-sm text-slate-100" />
            </label>

            <label class="space-y-2">
                <span class="text-xs uppercase tracking-wider text-slate-400">Quarantine threshold</span>
                <input name="quarantine_error_rate_threshold" type="number" min="0" step="0.1" value="{{ .Settings.QuarantineErrorRateThreshold }}" class="w-full rounded-lg border border-slate-700 bg-slate-900 px-3 py-2 text-sm text-slate-100" />
            </label>

            <label class="space-y-2">
                <span class="text-xs uppercase tracking-wider text-slate-400">Autoscale canary (%)</span>
                <input name="autoscale_canary_percent" type="number" min="1" max="100" value="{{ .Settings.AutoscaleCanaryPercent }}" class="w-full rounded-lg border border-slate-700 bg-slate-900 px-3 py-2 text-sm text-slate-100" />
            </label>
        </div>

        <div class="rounded-xl border border-slate-800 bg-slate-950/40 p-4">
            <h3 class="text-sm font-semibold">Live UI Refresh Intervals</h3>
            <p class="mt-1 text-xs text-slate-400">Controls dashboard live stream and page polling cadence.</p>
            <div class="mt-4 grid gap-4 md:grid-cols-4">
                <label class="space-y-2">
                    <span class="text-xs uppercase tracking-wider text-slate-400">Overview stream (sec)</span>
                    <input name="ui_overview_live_interval_seconds" type="number" min="2" max="60" value="{{ .Settings.UIOverviewLiveIntervalSecond }}" class="w-full rounded-lg border border-slate-700 bg-slate-900 px-3 py-2 text-sm text-slate-100" />
                </label>

                <label class="space-y-2">
                    <span class="text-xs uppercase tracking-wider text-slate-400">Workers refresh (sec)</span>
                    <input name="ui_workers_refresh_seconds" type="number" min="2" max="120" value="{{ .Settings.UIWorkersRefreshSecond }}" class="w-full rounded-lg border border-slate-700 bg-slate-900 px-3 py-2 text-sm text-slate-100" />
                </label>

                <label class="space-y-2">
                    <span class="text-xs uppercase tracking-wider text-slate-400">Pools refresh (sec)</span>
                    <input name="ui_pools_refresh_seconds" type="number" min="2" max="120" value="{{ .Settings.UIPoolsRefreshSecond }}" class="w-full rounded-lg border border-slate-700 bg-slate-900 px-3 py-2 text-sm text-slate-100" />
                </label>

                <label class="space-y-2">
                    <span class="text-xs uppercase tracking-wider text-slate-400">Alerts refresh (sec)</span>
                    <input name="ui_alerts_refresh_seconds" type="number" min="5" max="300" value="{{ .Settings.UIAlertsRefreshSecond }}" class="w-full rounded-lg border border-slate-700 bg-slate-900 px-3 py-2 text-sm text-slate-100" />
                </label>
            </div>
        </div>

        <div>
            <button type="submit" class="rounded-full bg-amber-500 px-5 py-2 text-xs font-semibold text-slate-900 hover:bg-amber-400">Save Settings</button>
        </div>
    </form>
</section>

<section class="mt-8 rounded-2xl border border-slate-800 bg-slate-900/60 p-6">
    <div class="flex items-center justify-between">
        <div>
            <h2 class="text-lg font-semibold">Provider Policy Controls</h2>
            <p class="text-sm text-slate-400">Manual provider mode overrides and policy reload controls.</p>
        </div>
        <form method="POST" action="{{ .BasePath }}/providers/policies/reload">
            <button type="submit" class="rounded-full bg-slate-200 px-4 py-2 text-xs font-semibold text-slate-900 hover:bg-white">Reload Policies</button>
        </form>
    </div>

    <div class="mt-4 grid gap-4 md:grid-cols-3">
        <div class="rounded-xl border border-slate-800 bg-slate-950/60 p-4">
            <p class="text-xs uppercase tracking-wider text-slate-400">Policy Engine</p>
            <p class="mt-2 text-sm font-medium">{{ if .ProviderPolicies.PolicyEngineEnabled }}Enabled{{ else }}Disabled{{ end }}</p>
        </div>
        <div class="rounded-xl border border-slate-800 bg-slate-950/60 p-4">
            <p class="text-xs uppercase tracking-wider text-slate-400">Adaptive Retry</p>
            <p class="mt-2 text-sm font-medium">{{ if .ProviderPolicies.AdaptiveRetryEnabled }}Enabled{{ else }}Disabled{{ end }}</p>
        </div>
        <div class="rounded-xl border border-slate-800 bg-slate-950/60 p-4">
            <p class="text-xs uppercase tracking-wider text-slate-400">Auto Protect</p>
            <p class="mt-2 text-sm font-medium">{{ if .ProviderPolicies.AutoProtectEnabled }}Enabled{{ else }}Disabled{{ end }}</p>
        </div>
    </div>

    <p class="mt-4 text-xs text-slate-400">
        Active policy version: {{ if .ProviderPolicies.ActiveVersion }}{{ .ProviderPolicies.ActiveVersion }}{{ else }}not set{{ end }} ·
        Last policy reload: {{ if .ProviderPolicies.LastReloadAt }}{{ .ProviderPolicies.LastReloadAt }}{{ else }}never{{ end }} ·
        Reload count: {{ .ProviderPolicies.ReloadCount }}
    </p>

    <div class="mt-5 overflow-x-auto">
        <table class="min-w-full text-sm">
            <thead class="text-left text-xs uppercase tracking-wider text-slate-400">
                <tr>
                    <th class="px-3 py-2">Provider</th>
                    <th class="px-3 py-2">Health</th>
                    <th class="px-3 py-2">Mode</th>
                    <th class="px-3 py-2">Tempfail</th>
                    <th class="px-3 py-2">Reject</th>
                    <th class="px-3 py-2">Unknown</th>
                    <th class="px-3 py-2">Policy Block</th>
                    <th class="px-3 py-2">Action</th>
                </tr>
            </thead>
            <tbody class="divide-y divide-slate-800">
                {{ range .ProviderHealth }}
                    <tr>
                        <td class="px-3 py-2 font-medium">{{ .Provider }}</td>
                        <td class="px-3 py-2">
                            <span class="rounded-full px-2 py-1 text-xs {{ if eq .Status "critical" }}bg-red-500/20 text-red-300{{ else if eq .Status "warning" }}bg-amber-500/20 text-amber-300{{ else }}bg-emerald-500/20 text-emerald-300{{ end }}">
                                {{ .Status }}
                            </span>
                        </td>
                        <td class="px-3 py-2">{{ .Mode }}</td>
                        <td class="px-3 py-2">{{ printf "%.2f" .TempfailRate }}</td>
                        <td class="px-3 py-2">{{ printf "%.2f" .RejectRate }}</td>
                        <td class="px-3 py-2">{{ printf "%.2f" .UnknownRate }}</td>
                        <td class="px-3 py-2">{{ printf "%.2f" .PolicyBlockedRate }}</td>
                        <td class="px-3 py-2">
                            <form method="POST" action="{{ $.BasePath }}/providers/{{ .Provider }}/mode" class="flex items-center gap-2">
                                <select name="mode" class="rounded-md border border-slate-700 bg-slate-900 px-2 py-1 text-xs">
                                    <option value="normal" {{ if eq .Mode "normal" }}selected{{ end }}>normal</option>
                                    <option value="cautious" {{ if eq .Mode "cautious" }}selected{{ end }}>cautious</option>
                                    <option value="drain" {{ if eq .Mode "drain" }}selected{{ end }}>drain</option>
                                </select>
                                <button type="submit" class="rounded-full bg-amber-500 px-3 py-1 text-xs font-semibold text-slate-900 hover:bg-amber-400">Set</button>
                            </form>
                        </td>
                    </tr>
                {{ else }}
                    <tr>
                        <td colspan="8" class="px-3 py-3 text-slate-400">No provider health data yet.</td>
                    </tr>
                {{ end }}
            </tbody>
        </table>
    </div>
</section>

<section class="mt-8 rounded-2xl border border-slate-800 bg-slate-900/60 p-6">
    <div class="flex items-center justify-between">
        <div>
            <h2 class="text-lg font-semibold">Policy Rollout Controls</h2>
            <p class="text-sm text-slate-400">Promote or rollback SMTP reply policy versions safely.</p>
        </div>
    </div>

    <div class="mt-4 grid gap-4 md:grid-cols-3">
        <div class="rounded-xl border border-slate-800 bg-slate-950/60 p-4">
            <p class="text-xs uppercase tracking-wider text-slate-400">Strict Payload Validation</p>
            <p class="mt-2 text-sm font-medium">{{ if .PolicyPayloadStrictValidationEnabled }}Enabled{{ else }}Disabled{{ end }}</p>
        </div>
        <div class="rounded-xl border border-slate-800 bg-slate-950/60 p-4">
            <p class="text-xs uppercase tracking-wider text-slate-400">Canary Autopilot</p>
            <p class="mt-2 text-sm font-medium">{{ if .PolicyCanaryAutopilotEnabled }}Enabled{{ else }}Disabled{{ end }}</p>
            <p class="mt-1 text-xs text-slate-400">Window: {{ .PolicyCanaryWindowMinutes }}m · Required windows: {{ .PolicyCanaryRequiredHealthWindows }}</p>
        </div>
        <div class="rounded-xl border border-slate-800 bg-slate-950/60 p-4">
            <p class="text-xs uppercase tracking-wider text-slate-400">Autopilot Gates</p>
            <p class="mt-2 text-xs text-slate-300">
                Unknown +{{ printf "%.2f" .PolicyCanaryUnknownRegressionThreshold }} ·
                Tempfail recovery -{{ printf "%.2f" .PolicyCanaryTempfailRecoveryDropThreshold }} ·
                Policy-block +{{ printf "%.2f" .PolicyCanaryPolicyBlockSpikeThreshold }}
            </p>
        </div>
    </div>

    <div class="mt-4 grid gap-4 md:grid-cols-2">
        <form method="POST" action="{{ .BasePath }}/policies/validate" class="space-y-3 rounded-xl border border-slate-800 bg-slate-950/60 p-4">
            <h3 class="text-sm font-semibold">Validate Policy Payload</h3>
            <label class="space-y-2 block">
                <span class="text-xs uppercase tracking-wider text-slate-400">Policy version</span>
                <input name="policy_version" type="text" placeholder="v2.1.0" class="w-full rounded-lg border border-slate-700 bg-slate-900 px-3 py-2 text-sm text-slate-100" />
            </label>
            <label class="space-y-2 block">
                <span class="text-xs uppercase tracking-wider text-slate-400">Notes</span>
                <input name="notes" type="text" placeholder="validation notes" class="w-full rounded-lg border border-slate-700 bg-slate-900 px-3 py-2 text-sm text-slate-100" />
            </label>
            <button type="submit" class="rounded-full bg-cyan-500 px-4 py-2 text-xs font-semibold text-slate-900 hover:bg-cyan-400">Validate</button>
        </form>

        <form method="POST" action="{{ .BasePath }}/policies/promote" class="space-y-3 rounded-xl border border-slate-800 bg-slate-950/60 p-4">
            <h3 class="text-sm font-semibold">Promote Policy</h3>
            <label class="space-y-2 block">
                <span class="text-xs uppercase tracking-wider text-slate-400">Policy version</span>
                <select name="policy_version" id="promote-policy-version" class="w-full rounded-lg border border-slate-700 bg-slate-900 px-3 py-2 text-sm text-slate-100">
                    <option value="">Select a validated version</option>
                    {{ range .PolicyVersions }}
                        <option value="{{ .Version }}" data-validation="{{ .ValidationStatus }}">{{ .Version }} ({{ .ValidationStatus }})</option>
                    {{ end }}
                </select>
            </label>
            <label class="space-y-2 block">
                <span class="text-xs uppercase tracking-wider text-slate-400">Canary percent</span>
                <input name="canary_percent" type="number" min="1" max="100" value="100" class="w-full rounded-lg border border-slate-700 bg-slate-900 px-3 py-2 text-sm text-slate-100" />
            </label>
            <label class="space-y-2 block">
                <span class="text-xs uppercase tracking-wider text-slate-400">Notes</span>
                <input name="notes" type="text" placeholder="reason for rollout" class="w-full rounded-lg border border-slate-700 bg-slate-900 px-3 py-2 text-sm text-slate-100" />
            </label>
            <p id="promote-validation-hint" class="text-xs text-slate-400">Only versions with validation status <strong>valid</strong> can be promoted.</p>
            <button id="promote-policy-button" type="submit" disabled class="rounded-full bg-amber-500 px-4 py-2 text-xs font-semibold text-slate-900 hover:bg-amber-400 disabled:cursor-not-allowed disabled:opacity-40">Promote</button>
        </form>

        <form method="POST" action="{{ .BasePath }}/policies/rollback" class="space-y-3 rounded-xl border border-slate-800 bg-slate-950/60 p-4">
            <h3 class="text-sm font-semibold">Rollback Policy</h3>
            <p class="text-xs text-slate-400">Rolls back to the previous promoted version from rollout history.</p>
            <label class="space-y-2 block">
                <span class="text-xs uppercase tracking-wider text-slate-400">Notes</span>
                <input name="notes" type="text" placeholder="reason for rollback" class="w-full rounded-lg border border-slate-700 bg-slate-900 px-3 py-2 text-sm text-slate-100" />
            </label>
            <button type="submit" class="rounded-full bg-rose-500 px-4 py-2 text-xs font-semibold text-white hover:bg-rose-400">Rollback</button>
        </form>
    </div>

    <div class="mt-6 grid gap-4 md:grid-cols-2">
        <div class="overflow-x-auto rounded-xl border border-slate-800 bg-slate-950/60">
            <table class="min-w-full text-sm">
                <thead class="text-left text-xs uppercase tracking-wider text-slate-400">
                    <tr>
                        <th class="px-3 py-2">Version</th>
                        <th class="px-3 py-2">Status</th>
                        <th class="px-3 py-2">Validation</th>
                        <th class="px-3 py-2">Canary</th>
                        <th class="px-3 py-2">Updated</th>
                    </tr>
                </thead>
                <tbody class="divide-y divide-slate-800">
                    {{ range .PolicyVersions }}
                        <tr>
                            <td class="px-3 py-2 font-medium">{{ .Version }}</td>
                            <td class="px-3 py-2">{{ if .Active }}active{{ else }}{{ .Status }}{{ end }}</td>
                            <td class="px-3 py-2">
                                <span class="rounded-full px-2 py-1 text-xs {{ if eq .ValidationStatus "valid" }}bg-emerald-500/20 text-emerald-300{{ else if eq .ValidationStatus "invalid" }}bg-rose-500/20 text-rose-300{{ else }}bg-slate-700 text-slate-200{{ end }}">
                                    {{ if .ValidationStatus }}{{ .ValidationStatus }}{{ else }}pending{{ end }}
                                </span>
                            </td>
                            <td class="px-3 py-2">{{ .CanaryPercent }}%</td>
                            <td class="px-3 py-2 text-xs text-slate-400">{{ .UpdatedAt }}</td>
                        </tr>
                    {{ else }}
                        <tr>
                            <td colspan="5" class="px-3 py-3 text-slate-400">No policy versions recorded yet.</td>
                        </tr>
                    {{ end }}
                </tbody>
            </table>
        </div>

        <div class="overflow-x-auto rounded-xl border border-slate-800 bg-slate-950/60">
            <table class="min-w-full text-sm">
                <thead class="text-left text-xs uppercase tracking-wider text-slate-400">
                    <tr>
                        <th class="px-3 py-2">Action</th>
                        <th class="px-3 py-2">Version</th>
                        <th class="px-3 py-2">Validation</th>
                        <th class="px-3 py-2">Canary</th>
                        <th class="px-3 py-2">At</th>
                    </tr>
                </thead>
                <tbody class="divide-y divide-slate-800">
                    {{ range .PolicyRollouts }}
                        <tr>
                            <td class="px-3 py-2">{{ .Action }}</td>
                            <td class="px-3 py-2">{{ .Version }}</td>
                            <td class="px-3 py-2">{{ if .ValidationStatus }}{{ .ValidationStatus }}{{ else }}pending{{ end }}</td>
                            <td class="px-3 py-2">{{ .CanaryPercent }}%</td>
                            <td class="px-3 py-2 text-xs text-slate-400">{{ .CreatedAt }}</td>
                        </tr>
                    {{ else }}
                        <tr>
                            <td colspan="5" class="px-3 py-3 text-slate-400">No rollout history yet.</td>
                        </tr>
                    {{ end }}
                </tbody>
            </table>
        </div>
    </div>
</section>
<script>
    window.addEventListener('DOMContentLoaded', () => {
        const versionSelect = document.getElementById('promote-policy-version');
        const promoteButton = document.getElementById('promote-policy-button');
        const hint = document.getElementById('promote-validation-hint');
        if (!versionSelect || !promoteButton) {
            return;
        }

        const syncState = () => {
            const selected = versionSelect.options[versionSelect.selectedIndex];
            const isValid = selected && selected.getAttribute('data-validation') === 'valid';
            promoteButton.disabled = !isValid;
            if (hint) {
                hint.textContent = isValid
                    ? 'Selected version is validated and ready for promote.'
                    : 'Only versions with validation status valid can be promoted.';
            }
        };

        versionSelect.addEventListener('change', syncState);
        syncState();
    });
</script>
{{ end }}
