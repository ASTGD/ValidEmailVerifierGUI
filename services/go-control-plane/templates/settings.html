{{ define "settings" }}
<section class="rounded-2xl border border-slate-800 bg-slate-900/60 p-6">
        <div class="flex items-center justify-between">
        <div>
            <h2 class="text-lg font-semibold">Runtime Safety Settings</h2>
            <p class="text-sm text-slate-400">Saved in Redis. Alerting, quarantine, and autoscale controls are hot-reloaded.</p>
        </div>
    </div>

    {{ if .Saved }}
    <div class="mt-4 rounded-xl border border-emerald-500/30 bg-emerald-500/10 p-4 text-sm text-emerald-200">
        Settings saved.
    </div>
    {{ end }}
    {{ if .RolledBack }}
    <div class="mt-4 rounded-xl border border-amber-500/30 bg-amber-500/10 p-4 text-sm text-amber-200">
        Rolled back to the previous runtime settings snapshot.
    </div>
    {{ end }}

    <form id="runtime-settings-form" method="POST" action="{{ .BasePath }}/settings" class="mt-6 space-y-5">
        <div class="rounded-xl border border-slate-800 bg-slate-950/40 p-4">
            <div class="flex flex-wrap items-center gap-2">
                <span class="text-xs font-semibold uppercase tracking-wider text-slate-400">Presets</span>
                <button type="button" class="settings-preset-btn" data-settings-preset="conservative">Conservative</button>
                <button type="button" class="settings-preset-btn" data-settings-preset="balanced">Balanced</button>
                <button type="button" class="settings-preset-btn" data-settings-preset="aggressive">Aggressive</button>
            </div>
            <p class="mt-2 text-xs text-slate-400">Preset applies to form fields only. Review change preview, then click Save Settings.</p>
        </div>
        <div class="rounded-xl border border-slate-800 bg-slate-950/40 p-4">
            <h3 class="text-sm font-semibold">Core Toggles</h3>
            <p class="mt-1 text-xs text-slate-400">High-impact controls grouped in one block.</p>
            <div class="mt-4 grid gap-4 md:grid-cols-2 xl:grid-cols-3">
                <label class="flex items-center gap-3 rounded-xl border border-slate-800 bg-slate-950/60 p-4">
                    <input type="checkbox" name="alerts_enabled" {{ if .Settings.AlertsEnabled }}checked{{ end }} class="h-4 w-4 rounded border-slate-600 bg-slate-900 text-amber-500 focus:ring-amber-500" />
                    <span>
                        <span class="block text-sm font-medium">Enable alerts{{ template "settings_help_tip" (index $.RuntimeHelp "alerts_enabled") }}</span>
                        <span class="block text-xs text-slate-400">Turns alert checks and notifications on.</span>
                    </span>
                </label>
                <label class="flex items-center gap-3 rounded-xl border border-slate-800 bg-slate-950/60 p-4">
                    <input type="checkbox" name="auto_actions_enabled" {{ if .Settings.AutoActionsEnabled }}checked{{ end }} class="h-4 w-4 rounded border-slate-600 bg-slate-900 text-amber-500 focus:ring-amber-500" />
                    <span>
                        <span class="block text-sm font-medium">Enable auto actions{{ template "settings_help_tip" (index $.RuntimeHelp "auto_actions_enabled") }}</span>
                        <span class="block text-xs text-slate-400">Drains workers exceeding thresholds.</span>
                    </span>
                </label>
                <label class="flex items-center gap-3 rounded-xl border border-slate-800 bg-slate-950/60 p-4">
                    <input type="checkbox" name="autoscale_enabled" {{ if .Settings.AutoscaleEnabled }}checked{{ end }} class="h-4 w-4 rounded border-slate-600 bg-slate-900 text-amber-500 focus:ring-amber-500" />
                    <span>
                        <span class="block text-sm font-medium">Enable autoscaling{{ template "settings_help_tip" (index $.RuntimeHelp "autoscale_enabled") }}</span>
                        <span class="block text-xs text-slate-400">Adjust pool desired counts within guardrails.</span>
                    </span>
                </label>
                <label class="flex items-center gap-3 rounded-xl border border-slate-800 bg-slate-950/60 p-4">
                    <input type="checkbox" name="provider_policy_engine_enabled" {{ if .Settings.ProviderPolicyEngineEnabled }}checked{{ end }} class="h-4 w-4 rounded border-slate-600 bg-slate-900 text-amber-500 focus:ring-amber-500" />
                    <span>
                        <span class="block text-sm font-medium">Enable provider policy engine{{ template "settings_help_tip" (index $.RuntimeHelp "provider_policy_engine_enabled") }}</span>
                        <span class="block text-xs text-slate-400">Use provider rule packs in SMTP control logic.</span>
                    </span>
                </label>
                <label class="flex items-center gap-3 rounded-xl border border-slate-800 bg-slate-950/60 p-4">
                    <input type="checkbox" name="adaptive_retry_enabled" {{ if .Settings.AdaptiveRetryEnabled }}checked{{ end }} class="h-4 w-4 rounded border-slate-600 bg-slate-900 text-amber-500 focus:ring-amber-500" />
                    <span>
                        <span class="block text-sm font-medium">Enable adaptive retry{{ template "settings_help_tip" (index $.RuntimeHelp "adaptive_retry_enabled") }}</span>
                        <span class="block text-xs text-slate-400">Provider-aware retry pacing for tempfails.</span>
                    </span>
                </label>
                <label class="flex items-center gap-3 rounded-xl border border-slate-800 bg-slate-950/60 p-4">
                    <input type="checkbox" name="provider_autoprotect_enabled" {{ if .Settings.ProviderAutoprotectEnabled }}checked{{ end }} class="h-4 w-4 rounded border-slate-600 bg-slate-900 text-amber-500 focus:ring-amber-500" />
                    <span>
                        <span class="block text-sm font-medium">Enable provider auto protect{{ template "settings_help_tip" (index $.RuntimeHelp "provider_autoprotect_enabled") }}</span>
                        <span class="block text-xs text-slate-400">Auto-shifts provider mode when health degrades.</span>
                    </span>
                </label>
                <label class="flex items-center gap-3 rounded-xl border border-slate-800 bg-slate-950/60 p-4">
                    <input type="checkbox" name="policy_canary_autopilot_enabled" {{ if .Settings.PolicyCanaryAutopilotEnabled }}checked{{ end }} class="h-4 w-4 rounded border-slate-600 bg-slate-900 text-amber-500 focus:ring-amber-500" />
                    <span>
                        <span class="block text-sm font-medium">Enable canary autopilot{{ template "settings_help_tip" (index $.RuntimeHelp "policy_canary_autopilot_enabled") }}</span>
                        <span class="block text-xs text-slate-400">Automatic step-up/rollback by KPI windows.</span>
                    </span>
                </label>
            </div>
        </div>

        <div class="rounded-xl border border-slate-800 bg-slate-950/40 p-4">
            <h3 class="text-sm font-semibold">Alerting and Reliability</h3>
            <div class="mt-4 grid gap-4 md:grid-cols-3">
                <label class="space-y-2">
                    <span class="text-xs uppercase tracking-wider text-slate-400">Error threshold (errors/min){{ template "settings_help_tip" (index $.RuntimeHelp "alert_error_rate_threshold") }}</span>
                    <input name="alert_error_rate_threshold" type="number" min="0" step="0.1" value="{{ .Settings.AlertErrorRateThreshold }}" class="w-full rounded-lg border border-slate-700 bg-slate-900 px-3 py-2 text-sm text-slate-100" />
                </label>
                <label class="space-y-2">
                    <span class="text-xs uppercase tracking-wider text-slate-400">Heartbeat grace (seconds){{ template "settings_help_tip" (index $.RuntimeHelp "alert_heartbeat_grace_seconds") }}</span>
                    <input name="alert_heartbeat_grace_seconds" type="number" min="1" value="{{ .Settings.AlertHeartbeatGraceSecond }}" class="w-full rounded-lg border border-slate-700 bg-slate-900 px-3 py-2 text-sm text-slate-100" />
                </label>
                <label class="space-y-2">
                    <span class="text-xs uppercase tracking-wider text-slate-400">Alert cooldown (seconds){{ template "settings_help_tip" (index $.RuntimeHelp "alert_cooldown_seconds") }}</span>
                    <input name="alert_cooldown_seconds" type="number" min="1" value="{{ .Settings.AlertCooldownSecond }}" class="w-full rounded-lg border border-slate-700 bg-slate-900 px-3 py-2 text-sm text-slate-100" />
                </label>
                <label class="space-y-2">
                    <span class="text-xs uppercase tracking-wider text-slate-400">Alert check interval (seconds){{ template "settings_help_tip" (index $.RuntimeHelp "alert_check_interval_seconds") }}</span>
                    <input name="alert_check_interval_seconds" type="number" min="5" value="{{ .Settings.AlertCheckIntervalSecond }}" class="w-full rounded-lg border border-slate-700 bg-slate-900 px-3 py-2 text-sm text-slate-100" />
                </label>
                <label class="space-y-2">
                    <span class="text-xs uppercase tracking-wider text-slate-400">Stale worker TTL (seconds){{ template "settings_help_tip" (index $.RuntimeHelp "stale_worker_ttl_seconds") }}</span>
                    <input name="stale_worker_ttl_seconds" type="number" min="60" value="{{ .Settings.StaleWorkerTTLSecond }}" class="w-full rounded-lg border border-slate-700 bg-slate-900 px-3 py-2 text-sm text-slate-100" />
                </label>
                <label class="space-y-2">
                    <span class="text-xs uppercase tracking-wider text-slate-400">Stuck desired grace (seconds){{ template "settings_help_tip" (index $.RuntimeHelp "stuck_desired_grace_seconds") }}</span>
                    <input name="stuck_desired_grace_seconds" type="number" min="30" value="{{ .Settings.StuckDesiredGraceSecond }}" class="w-full rounded-lg border border-slate-700 bg-slate-900 px-3 py-2 text-sm text-slate-100" />
                </label>
                <label class="space-y-2">
                    <span class="text-xs uppercase tracking-wider text-slate-400">Quarantine threshold{{ template "settings_help_tip" (index $.RuntimeHelp "quarantine_error_rate_threshold") }}</span>
                    <input name="quarantine_error_rate_threshold" type="number" min="0" step="0.1" value="{{ .Settings.QuarantineErrorRateThreshold }}" class="w-full rounded-lg border border-slate-700 bg-slate-900 px-3 py-2 text-sm text-slate-100" />
                </label>
            </div>
        </div>

        <div class="rounded-xl border border-slate-800 bg-slate-950/40 p-4">
            <h3 class="text-sm font-semibold">Provider Health Thresholds</h3>
            <div class="mt-4 grid gap-4 md:grid-cols-3">
                <label class="space-y-2">
                    <span class="text-xs uppercase tracking-wider text-slate-400">Tempfail warn rate{{ template "settings_help_tip" (index $.RuntimeHelp "provider_tempfail_warn_rate") }}</span>
                    <input name="provider_tempfail_warn_rate" type="number" min="0" max="1" step="0.01" value="{{ .Settings.ProviderTempfailWarnRate }}" class="w-full rounded-lg border border-slate-700 bg-slate-900 px-3 py-2 text-sm text-slate-100" />
                </label>
                <label class="space-y-2">
                    <span class="text-xs uppercase tracking-wider text-slate-400">Tempfail critical rate{{ template "settings_help_tip" (index $.RuntimeHelp "provider_tempfail_critical_rate") }}</span>
                    <input name="provider_tempfail_critical_rate" type="number" min="0" max="1" step="0.01" value="{{ .Settings.ProviderTempfailCriticalRate }}" class="w-full rounded-lg border border-slate-700 bg-slate-900 px-3 py-2 text-sm text-slate-100" />
                </label>
                <label class="space-y-2">
                    <span class="text-xs uppercase tracking-wider text-slate-400">Reject warn rate{{ template "settings_help_tip" (index $.RuntimeHelp "provider_reject_warn_rate") }}</span>
                    <input name="provider_reject_warn_rate" type="number" min="0" max="1" step="0.01" value="{{ .Settings.ProviderRejectWarnRate }}" class="w-full rounded-lg border border-slate-700 bg-slate-900 px-3 py-2 text-sm text-slate-100" />
                </label>
                <label class="space-y-2">
                    <span class="text-xs uppercase tracking-wider text-slate-400">Reject critical rate{{ template "settings_help_tip" (index $.RuntimeHelp "provider_reject_critical_rate") }}</span>
                    <input name="provider_reject_critical_rate" type="number" min="0" max="1" step="0.01" value="{{ .Settings.ProviderRejectCriticalRate }}" class="w-full rounded-lg border border-slate-700 bg-slate-900 px-3 py-2 text-sm text-slate-100" />
                </label>
                <label class="space-y-2">
                    <span class="text-xs uppercase tracking-wider text-slate-400">Unknown warn rate{{ template "settings_help_tip" (index $.RuntimeHelp "provider_unknown_warn_rate") }}</span>
                    <input name="provider_unknown_warn_rate" type="number" min="0" max="1" step="0.01" value="{{ .Settings.ProviderUnknownWarnRate }}" class="w-full rounded-lg border border-slate-700 bg-slate-900 px-3 py-2 text-sm text-slate-100" />
                </label>
                <label class="space-y-2">
                    <span class="text-xs uppercase tracking-wider text-slate-400">Unknown critical rate{{ template "settings_help_tip" (index $.RuntimeHelp "provider_unknown_critical_rate") }}</span>
                    <input name="provider_unknown_critical_rate" type="number" min="0" max="1" step="0.01" value="{{ .Settings.ProviderUnknownCriticalRate }}" class="w-full rounded-lg border border-slate-700 bg-slate-900 px-3 py-2 text-sm text-slate-100" />
                </label>
            </div>
        </div>

        <div class="rounded-xl border border-slate-800 bg-slate-950/40 p-4">
            <h3 class="text-sm font-semibold">Autoscale Guardrails</h3>
            <div class="mt-4 grid gap-4 md:grid-cols-3">
                <label class="space-y-2">
                    <span class="text-xs uppercase tracking-wider text-slate-400">Autoscale interval (seconds){{ template "settings_help_tip" (index $.RuntimeHelp "autoscale_interval_seconds") }}</span>
                    <input name="autoscale_interval_seconds" type="number" min="5" value="{{ .Settings.AutoscaleIntervalSecond }}" class="w-full rounded-lg border border-slate-700 bg-slate-900 px-3 py-2 text-sm text-slate-100" />
                </label>
                <label class="space-y-2">
                    <span class="text-xs uppercase tracking-wider text-slate-400">Autoscale cooldown (seconds){{ template "settings_help_tip" (index $.RuntimeHelp "autoscale_cooldown_seconds") }}</span>
                    <input name="autoscale_cooldown_seconds" type="number" min="10" value="{{ .Settings.AutoscaleCooldownSecond }}" class="w-full rounded-lg border border-slate-700 bg-slate-900 px-3 py-2 text-sm text-slate-100" />
                </label>
                <label class="space-y-2">
                    <span class="text-xs uppercase tracking-wider text-slate-400">Autoscale canary (%){{ template "settings_help_tip" (index $.RuntimeHelp "autoscale_canary_percent") }}</span>
                    <input name="autoscale_canary_percent" type="number" min="1" max="100" value="{{ .Settings.AutoscaleCanaryPercent }}" class="w-full rounded-lg border border-slate-700 bg-slate-900 px-3 py-2 text-sm text-slate-100" />
                </label>
                <label class="space-y-2">
                    <span class="text-xs uppercase tracking-wider text-slate-400">Autoscale min desired{{ template "settings_help_tip" (index $.RuntimeHelp "autoscale_min_desired") }}</span>
                    <input name="autoscale_min_desired" type="number" min="0" value="{{ .Settings.AutoscaleMinDesired }}" class="w-full rounded-lg border border-slate-700 bg-slate-900 px-3 py-2 text-sm text-slate-100" />
                </label>
                <label class="space-y-2">
                    <span class="text-xs uppercase tracking-wider text-slate-400">Autoscale max desired{{ template "settings_help_tip" (index $.RuntimeHelp "autoscale_max_desired") }}</span>
                    <input name="autoscale_max_desired" type="number" min="{{ .Settings.AutoscaleMinDesired }}" value="{{ .Settings.AutoscaleMaxDesired }}" class="w-full rounded-lg border border-slate-700 bg-slate-900 px-3 py-2 text-sm text-slate-100" />
                </label>
            </div>
        </div>

        <div class="rounded-xl border border-slate-800 bg-slate-950/40 p-4">
            <h3 class="text-sm font-semibold">Canary Autopilot Gates</h3>
            <div class="mt-4 grid gap-4 md:grid-cols-3">
                <label class="space-y-2">
                    <span class="text-xs uppercase tracking-wider text-slate-400">Window (minutes){{ template "settings_help_tip" (index $.RuntimeHelp "policy_canary_window_minutes") }}</span>
                    <input name="policy_canary_window_minutes" type="number" min="1" value="{{ .Settings.PolicyCanaryWindowMinutes }}" class="w-full rounded-lg border border-slate-700 bg-slate-900 px-3 py-2 text-sm text-slate-100" />
                </label>
                <label class="space-y-2">
                    <span class="text-xs uppercase tracking-wider text-slate-400">Required healthy windows{{ template "settings_help_tip" (index $.RuntimeHelp "policy_canary_required_health_windows") }}</span>
                    <input name="policy_canary_required_health_windows" type="number" min="1" value="{{ .Settings.PolicyCanaryRequiredHealthWindows }}" class="w-full rounded-lg border border-slate-700 bg-slate-900 px-3 py-2 text-sm text-slate-100" />
                </label>
                <label class="space-y-2">
                    <span class="text-xs uppercase tracking-wider text-slate-400">Minimum provider workers{{ template "settings_help_tip" (index $.RuntimeHelp "policy_canary_min_provider_workers") }}</span>
                    <input name="policy_canary_min_provider_workers" type="number" min="1" value="{{ .Settings.PolicyCanaryMinProviderWorkers }}" class="w-full rounded-lg border border-slate-700 bg-slate-900 px-3 py-2 text-sm text-slate-100" />
                </label>
                <label class="space-y-2">
                    <span class="text-xs uppercase tracking-wider text-slate-400">Unknown regression threshold{{ template "settings_help_tip" (index $.RuntimeHelp "policy_canary_unknown_regression_threshold") }}</span>
                    <input name="policy_canary_unknown_regression_threshold" type="number" min="0" max="1" step="0.01" value="{{ .Settings.PolicyCanaryUnknownRegressionThreshold }}" class="w-full rounded-lg border border-slate-700 bg-slate-900 px-3 py-2 text-sm text-slate-100" />
                </label>
                <label class="space-y-2">
                    <span class="text-xs uppercase tracking-wider text-slate-400">Tempfail recovery drop threshold{{ template "settings_help_tip" (index $.RuntimeHelp "policy_canary_tempfail_recovery_drop_threshold") }}</span>
                    <input name="policy_canary_tempfail_recovery_drop_threshold" type="number" min="0" max="1" step="0.01" value="{{ .Settings.PolicyCanaryTempfailRecoveryDropThreshold }}" class="w-full rounded-lg border border-slate-700 bg-slate-900 px-3 py-2 text-sm text-slate-100" />
                </label>
                <label class="space-y-2">
                    <span class="text-xs uppercase tracking-wider text-slate-400">Policy-block spike threshold{{ template "settings_help_tip" (index $.RuntimeHelp "policy_canary_policy_block_spike_threshold") }}</span>
                    <input name="policy_canary_policy_block_spike_threshold" type="number" min="0" max="1" step="0.01" value="{{ .Settings.PolicyCanaryPolicyBlockSpikeThreshold }}" class="w-full rounded-lg border border-slate-700 bg-slate-900 px-3 py-2 text-sm text-slate-100" />
                </label>
            </div>
        </div>

        <div class="rounded-xl border border-slate-800 bg-slate-950/40 p-4">
            <h3 class="text-sm font-semibold">Live UI Refresh Intervals</h3>
            <p class="mt-1 text-xs text-slate-400">Controls dashboard live stream and page polling cadence.</p>
            <div class="mt-4 grid gap-4 md:grid-cols-4">
                <label class="space-y-2">
                    <span class="text-xs uppercase tracking-wider text-slate-400">Overview stream (sec){{ template "settings_help_tip" (index $.RuntimeHelp "ui_overview_live_interval_seconds") }}</span>
                    <input name="ui_overview_live_interval_seconds" type="number" min="2" max="60" value="{{ .Settings.UIOverviewLiveIntervalSecond }}" class="w-full rounded-lg border border-slate-700 bg-slate-900 px-3 py-2 text-sm text-slate-100" />
                </label>
                <label class="space-y-2">
                    <span class="text-xs uppercase tracking-wider text-slate-400">Workers refresh (sec){{ template "settings_help_tip" (index $.RuntimeHelp "ui_workers_refresh_seconds") }}</span>
                    <input name="ui_workers_refresh_seconds" type="number" min="2" max="120" value="{{ .Settings.UIWorkersRefreshSecond }}" class="w-full rounded-lg border border-slate-700 bg-slate-900 px-3 py-2 text-sm text-slate-100" />
                </label>
                <label class="space-y-2">
                    <span class="text-xs uppercase tracking-wider text-slate-400">Pools refresh (sec){{ template "settings_help_tip" (index $.RuntimeHelp "ui_pools_refresh_seconds") }}</span>
                    <input name="ui_pools_refresh_seconds" type="number" min="2" max="120" value="{{ .Settings.UIPoolsRefreshSecond }}" class="w-full rounded-lg border border-slate-700 bg-slate-900 px-3 py-2 text-sm text-slate-100" />
                </label>
                <label class="space-y-2">
                    <span class="text-xs uppercase tracking-wider text-slate-400">Alerts refresh (sec){{ template "settings_help_tip" (index $.RuntimeHelp "ui_alerts_refresh_seconds") }}</span>
                    <input name="ui_alerts_refresh_seconds" type="number" min="5" max="300" value="{{ .Settings.UIAlertsRefreshSecond }}" class="w-full rounded-lg border border-slate-700 bg-slate-900 px-3 py-2 text-sm text-slate-100" />
                </label>
            </div>
        </div>

        <div class="space-y-3">
            <div id="settings-risk-warning" class="settings-risk-warning hidden">
                <p id="settings-risk-warning-title" class="settings-risk-warning__title">Unsafe values detected</p>
                <p id="settings-risk-warning-meta" class="settings-risk-warning__meta">Adjust values to continue.</p>
                <div id="settings-risk-warning-list" class="settings-risk-warning__list"></div>
            </div>
            <div id="settings-change-preview" class="settings-change-preview hidden">
                <p class="settings-change-preview__title">Pending changes</p>
                <p id="settings-change-meta" class="settings-change-preview__meta">No unsaved changes.</p>
                <div id="settings-change-list" class="settings-change-preview__list"></div>
            </div>
            <div class="flex flex-wrap items-center gap-2">
                <button id="runtime-settings-save-button" type="submit" class="rounded-full bg-amber-500 px-5 py-2 text-xs font-semibold text-slate-900 hover:bg-amber-400 disabled:cursor-not-allowed disabled:opacity-40">Save Settings</button>
            </div>
        </div>
    </form>
    <div class="mt-3 flex flex-wrap items-center gap-2">
        <button id="runtime-settings-set-all-recommended" type="button" class="rounded-full border border-cyan-500/60 bg-cyan-500/10 px-4 py-2 text-xs font-semibold text-cyan-200 hover:bg-cyan-500/20">Set All to Recommended</button>
        {{ if .HasRollbackSnapshot }}
            <form method="POST" action="{{ .BasePath }}/settings/rollback">
                <button type="submit" class="rounded-full border border-slate-600 bg-slate-900 px-4 py-2 text-xs font-semibold text-slate-200 hover:bg-slate-800">Rollback Last Save</button>
            </form>
        {{ else }}
            <span class="text-xs text-slate-500">Rollback available after the first saved change.</span>
        {{ end }}
    </div>
</section>

<section class="mt-8 rounded-2xl border border-slate-800 bg-slate-900/60 p-6">
    <div class="flex items-center justify-between">
        <div>
            <h2 class="text-lg font-semibold">Provider Policy Controls{{ template "settings_help_tip" (index .RuntimeHelp "provider_policy_controls") }}</h2>
            <p class="text-sm text-slate-400">Manual provider mode overrides and policy reload controls.</p>
        </div>
        <form method="POST" action="{{ .BasePath }}/providers/policies/reload">
            <button type="submit" class="rounded-full bg-slate-200 px-4 py-2 text-xs font-semibold text-slate-900 hover:bg-white">Reload Policies</button>
        </form>
    </div>

    <div class="mt-4 grid gap-4 md:grid-cols-3">
        <div class="rounded-xl border border-slate-800 bg-slate-950/60 p-4">
            <p class="text-xs uppercase tracking-wider text-slate-400">Policy Engine</p>
            <p class="mt-2 text-sm font-medium">{{ if .ProviderPolicies.PolicyEngineEnabled }}Enabled{{ else }}Disabled{{ end }}</p>
        </div>
        <div class="rounded-xl border border-slate-800 bg-slate-950/60 p-4">
            <p class="text-xs uppercase tracking-wider text-slate-400">Adaptive Retry</p>
            <p class="mt-2 text-sm font-medium">{{ if .ProviderPolicies.AdaptiveRetryEnabled }}Enabled{{ else }}Disabled{{ end }}</p>
        </div>
        <div class="rounded-xl border border-slate-800 bg-slate-950/60 p-4">
            <p class="text-xs uppercase tracking-wider text-slate-400">Auto Protect</p>
            <p class="mt-2 text-sm font-medium">{{ if .ProviderPolicies.AutoProtectEnabled }}Enabled{{ else }}Disabled{{ end }}</p>
        </div>
    </div>

    <p class="mt-4 text-xs text-slate-400">
        Active policy version: {{ if .ProviderPolicies.ActiveVersion }}{{ .ProviderPolicies.ActiveVersion }}{{ else }}not set{{ end }} ·
        Last policy reload: {{ if .ProviderPolicies.LastReloadAt }}{{ .ProviderPolicies.LastReloadAt }}{{ else }}never{{ end }} ·
        Reload count: {{ .ProviderPolicies.ReloadCount }}
    </p>

    <div class="mt-5 overflow-x-auto">
        <table class="min-w-full text-sm">
            <thead class="text-left text-xs uppercase tracking-wider text-slate-400">
                <tr>
                    <th class="px-3 py-2">Provider</th>
                    <th class="px-3 py-2">Health</th>
                    <th class="px-3 py-2">Mode</th>
                    <th class="px-3 py-2">Tempfail</th>
                    <th class="px-3 py-2">Reject</th>
                    <th class="px-3 py-2">Unknown</th>
                    <th class="px-3 py-2">Policy Block</th>
                    <th class="px-3 py-2">Action</th>
                </tr>
            </thead>
            <tbody class="divide-y divide-slate-800">
                {{ range .ProviderHealth }}
                    <tr>
                        <td class="px-3 py-2 font-medium">{{ .Provider }}</td>
                        <td class="px-3 py-2">
                            <span class="rounded-full px-2 py-1 text-xs {{ if eq .Status "critical" }}bg-red-500/20 text-red-300{{ else if eq .Status "warning" }}bg-amber-500/20 text-amber-300{{ else }}bg-emerald-500/20 text-emerald-300{{ end }}">
                                {{ .Status }}
                            </span>
                        </td>
                        <td class="px-3 py-2">{{ .Mode }}</td>
                        <td class="px-3 py-2">{{ printf "%.2f" .TempfailRate }}</td>
                        <td class="px-3 py-2">{{ printf "%.2f" .RejectRate }}</td>
                        <td class="px-3 py-2">{{ printf "%.2f" .UnknownRate }}</td>
                        <td class="px-3 py-2">{{ printf "%.2f" .PolicyBlockedRate }}</td>
                        <td class="px-3 py-2">
                            <form method="POST" action="{{ $.BasePath }}/providers/{{ .Provider }}/mode" class="flex items-center gap-2">
                                <select name="mode" class="rounded-md border border-slate-700 bg-slate-900 px-2 py-1 text-xs">
                                    <option value="normal" {{ if eq .Mode "normal" }}selected{{ end }}>normal</option>
                                    <option value="cautious" {{ if eq .Mode "cautious" }}selected{{ end }}>cautious</option>
                                    <option value="drain" {{ if eq .Mode "drain" }}selected{{ end }}>drain</option>
                                    <option value="quarantine" {{ if eq .Mode "quarantine" }}selected{{ end }}>quarantine</option>
                                    <option value="degraded_probe" {{ if eq .Mode "degraded_probe" }}selected{{ end }}>degraded_probe</option>
                                </select>
                                <button type="submit" class="rounded-full bg-amber-500 px-3 py-1 text-xs font-semibold text-slate-900 hover:bg-amber-400">Set</button>
                            </form>
                        </td>
                    </tr>
                {{ else }}
                    <tr>
                        <td colspan="8" class="px-3 py-3 text-slate-400">No provider health data yet.</td>
                    </tr>
                {{ end }}
            </tbody>
        </table>
    </div>
</section>

<section class="mt-8 rounded-2xl border border-slate-800 bg-slate-900/60 p-6">
    <div class="flex items-center justify-between">
        <div>
            <h2 class="text-lg font-semibold">Policy Rollout Controls{{ template "settings_help_tip" (index .RuntimeHelp "policy_rollout_controls") }}</h2>
            <p class="text-sm text-slate-400">Promote or rollback SMTP reply policy versions safely.</p>
        </div>
    </div>

    <div class="mt-4 grid gap-4 md:grid-cols-3">
        <div class="rounded-xl border border-slate-800 bg-slate-950/60 p-4">
            <p class="text-xs uppercase tracking-wider text-slate-400">Strict Payload Validation</p>
            <p class="mt-2 text-sm font-medium">{{ if .PolicyPayloadStrictValidationEnabled }}Enabled{{ else }}Disabled{{ end }}</p>
        </div>
        <div class="rounded-xl border border-slate-800 bg-slate-950/60 p-4">
            <p class="text-xs uppercase tracking-wider text-slate-400">Canary Autopilot</p>
            <p class="mt-2 text-sm font-medium">{{ if .PolicyCanaryAutopilotEnabled }}Enabled{{ else }}Disabled{{ end }}</p>
            <p class="mt-1 text-xs text-slate-400">Window: {{ .PolicyCanaryWindowMinutes }}m · Required windows: {{ .PolicyCanaryRequiredHealthWindows }}</p>
        </div>
        <div class="rounded-xl border border-slate-800 bg-slate-950/60 p-4">
            <p class="text-xs uppercase tracking-wider text-slate-400">Autopilot Gates</p>
            <p class="mt-2 text-xs text-slate-300">
                Unknown +{{ printf "%.2f" .PolicyCanaryUnknownRegressionThreshold }} ·
                Tempfail recovery -{{ printf "%.2f" .PolicyCanaryTempfailRecoveryDropThreshold }} ·
                Policy-block +{{ printf "%.2f" .PolicyCanaryPolicyBlockSpikeThreshold }}
            </p>
        </div>
    </div>

    <div class="mt-4 grid gap-4 md:grid-cols-2">
        <form method="POST" action="{{ .BasePath }}/policies/validate" class="space-y-3 rounded-xl border border-slate-800 bg-slate-950/60 p-4">
            <h3 class="text-sm font-semibold">Validate Policy Payload</h3>
            <label class="space-y-2 block">
                <span class="text-xs uppercase tracking-wider text-slate-400">Policy version</span>
                <input name="policy_version" type="text" placeholder="v2.1.0" class="w-full rounded-lg border border-slate-700 bg-slate-900 px-3 py-2 text-sm text-slate-100" />
            </label>
            <label class="space-y-2 block">
                <span class="text-xs uppercase tracking-wider text-slate-400">Notes</span>
                <input name="notes" type="text" placeholder="validation notes" class="w-full rounded-lg border border-slate-700 bg-slate-900 px-3 py-2 text-sm text-slate-100" />
            </label>
            <button type="submit" class="rounded-full bg-cyan-500 px-4 py-2 text-xs font-semibold text-slate-900 hover:bg-cyan-400">Validate</button>
        </form>

        <form method="POST" action="{{ .BasePath }}/policies/promote" class="space-y-3 rounded-xl border border-slate-800 bg-slate-950/60 p-4">
            <h3 class="text-sm font-semibold">Promote Policy</h3>
            <label class="space-y-2 block">
                <span class="text-xs uppercase tracking-wider text-slate-400">Policy version</span>
                <select name="policy_version" id="promote-policy-version" class="w-full rounded-lg border border-slate-700 bg-slate-900 px-3 py-2 text-sm text-slate-100">
                    <option value="">Select a validated version</option>
                    {{ range .PolicyVersions }}
                        <option value="{{ .Version }}" data-validation="{{ .ValidationStatus }}">{{ .Version }} ({{ .ValidationStatus }})</option>
                    {{ end }}
                </select>
            </label>
            <label class="space-y-2 block">
                <span class="text-xs uppercase tracking-wider text-slate-400">Canary percent</span>
                <input name="canary_percent" type="number" min="1" max="100" value="100" class="w-full rounded-lg border border-slate-700 bg-slate-900 px-3 py-2 text-sm text-slate-100" />
            </label>
            <label class="space-y-2 block">
                <span class="text-xs uppercase tracking-wider text-slate-400">Notes</span>
                <input name="notes" type="text" placeholder="reason for rollout" class="w-full rounded-lg border border-slate-700 bg-slate-900 px-3 py-2 text-sm text-slate-100" />
            </label>
            <p id="promote-validation-hint" class="text-xs text-slate-400">Only versions with validation status <strong>valid</strong> can be promoted.</p>
            <button id="promote-policy-button" type="submit" disabled class="rounded-full bg-amber-500 px-4 py-2 text-xs font-semibold text-slate-900 hover:bg-amber-400 disabled:cursor-not-allowed disabled:opacity-40">Promote</button>
        </form>

        <form method="POST" action="{{ .BasePath }}/policies/rollback" class="space-y-3 rounded-xl border border-slate-800 bg-slate-950/60 p-4">
            <h3 class="text-sm font-semibold">Rollback Policy</h3>
            <p class="text-xs text-slate-400">Rolls back to the previous promoted version from rollout history.</p>
            <label class="space-y-2 block">
                <span class="text-xs uppercase tracking-wider text-slate-400">Notes</span>
                <input name="notes" type="text" placeholder="reason for rollback" class="w-full rounded-lg border border-slate-700 bg-slate-900 px-3 py-2 text-sm text-slate-100" />
            </label>
            <button type="submit" class="rounded-full bg-rose-500 px-4 py-2 text-xs font-semibold text-white hover:bg-rose-400">Rollback</button>
        </form>
    </div>

    <div class="mt-6 grid gap-4 md:grid-cols-2">
        <div class="overflow-x-auto rounded-xl border border-slate-800 bg-slate-950/60">
            <table class="min-w-full text-sm">
                <thead class="text-left text-xs uppercase tracking-wider text-slate-400">
                    <tr>
                        <th class="px-3 py-2">Version</th>
                        <th class="px-3 py-2">Status</th>
                        <th class="px-3 py-2">Validation</th>
                        <th class="px-3 py-2">Canary</th>
                        <th class="px-3 py-2">Updated</th>
                    </tr>
                </thead>
                <tbody class="divide-y divide-slate-800">
                    {{ range .PolicyVersions }}
                        <tr>
                            <td class="px-3 py-2 font-medium">{{ .Version }}</td>
                            <td class="px-3 py-2">{{ if .Active }}active{{ else }}{{ .Status }}{{ end }}</td>
                            <td class="px-3 py-2">
                                <span class="rounded-full px-2 py-1 text-xs {{ if eq .ValidationStatus "valid" }}bg-emerald-500/20 text-emerald-300{{ else if eq .ValidationStatus "invalid" }}bg-rose-500/20 text-rose-300{{ else }}bg-slate-700 text-slate-200{{ end }}">
                                    {{ if .ValidationStatus }}{{ .ValidationStatus }}{{ else }}pending{{ end }}
                                </span>
                            </td>
                            <td class="px-3 py-2">{{ .CanaryPercent }}%</td>
                            <td class="px-3 py-2 text-xs text-slate-400">{{ .UpdatedAt }}</td>
                        </tr>
                    {{ else }}
                        <tr>
                            <td colspan="5" class="px-3 py-3 text-slate-400">No policy versions recorded yet.</td>
                        </tr>
                    {{ end }}
                </tbody>
            </table>
        </div>

        <div class="overflow-x-auto rounded-xl border border-slate-800 bg-slate-950/60">
            <table class="min-w-full text-sm">
                <thead class="text-left text-xs uppercase tracking-wider text-slate-400">
                    <tr>
                        <th class="px-3 py-2">Action</th>
                        <th class="px-3 py-2">Version</th>
                        <th class="px-3 py-2">Validation</th>
                        <th class="px-3 py-2">Canary</th>
                        <th class="px-3 py-2">At</th>
                    </tr>
                </thead>
                <tbody class="divide-y divide-slate-800">
                    {{ range .PolicyRollouts }}
                        <tr>
                            <td class="px-3 py-2">{{ .Action }}</td>
                            <td class="px-3 py-2">{{ .Version }}</td>
                            <td class="px-3 py-2">{{ if .ValidationStatus }}{{ .ValidationStatus }}{{ else }}pending{{ end }}</td>
                            <td class="px-3 py-2">{{ .CanaryPercent }}%</td>
                            <td class="px-3 py-2 text-xs text-slate-400">{{ .CreatedAt }}</td>
                        </tr>
                    {{ else }}
                        <tr>
                            <td colspan="5" class="px-3 py-3 text-slate-400">No rollout history yet.</td>
                        </tr>
                    {{ end }}
                </tbody>
            </table>
        </div>
    </div>
</section>
<script>
    window.addEventListener('DOMContentLoaded', () => {
        const runtimeHelp = {{ toJSON .RuntimeHelp }};
        const baselineSettings = {{ toJSON .Settings }};
        const defaultSettings = {{ toJSON .DefaultSettings }};
        const runtimeSettingsForm = document.getElementById('runtime-settings-form');
        const versionSelect = document.getElementById('promote-policy-version');
        const promoteButton = document.getElementById('promote-policy-button');
        const hint = document.getElementById('promote-validation-hint');
        const helpTips = Array.from(document.querySelectorAll('.help-tip'));
        const presetButtons = Array.from(document.querySelectorAll('[data-settings-preset]'));
        const previewContainer = document.getElementById('settings-change-preview');
        const previewMeta = document.getElementById('settings-change-meta');
        const previewList = document.getElementById('settings-change-list');
        const riskWarningContainer = document.getElementById('settings-risk-warning');
        const riskWarningTitle = document.getElementById('settings-risk-warning-title');
        const riskWarningMeta = document.getElementById('settings-risk-warning-meta');
        const riskWarningList = document.getElementById('settings-risk-warning-list');
        const runtimeSaveButton = document.getElementById('runtime-settings-save-button');
        const setAllRecommendedButton = document.getElementById('runtime-settings-set-all-recommended');

        const closeHelpTips = () => {
            helpTips.forEach((tip) => {
                tip.removeAttribute('open');
            });
        };

        document.addEventListener('click', (event) => {
            helpTips.forEach((tip) => {
                if (!tip.contains(event.target)) {
                    tip.removeAttribute('open');
                }
            });
        });

        document.addEventListener('keydown', (event) => {
            if (event.key === 'Escape') {
                closeHelpTips();
            }
        });

        const parseInputValue = (input) => {
            if (input.type === 'checkbox') {
                return input.checked;
            }
            if (input.type === 'number') {
                const value = Number.parseFloat(input.value);
                if (Number.isNaN(value)) {
                    return null;
                }
                return value;
            }

            return input.value;
        };

        const normalizeNumber = (value, input) => {
            if (typeof value !== 'number' || Number.isNaN(value)) {
                return null;
            }

            const min = input.min !== '' ? Number.parseFloat(input.min) : null;
            const max = input.max !== '' ? Number.parseFloat(input.max) : null;
            let next = value;
            if (min !== null && next < min) {
                next = min;
            }
            if (max !== null && next > max) {
                next = max;
            }
            return next;
        };

        const formatValue = (input, value) => {
            if (input.type === 'checkbox') {
                return value ? 'Enabled' : 'Disabled';
            }
            if (typeof value === 'number') {
                if (input.step && input.step.includes('.')) {
                    return value.toFixed(2);
                }
                return Math.round(value).toString();
            }
            return String(value);
        };

        const setInputValue = (input, value) => {
            if (input.type === 'checkbox') {
                input.checked = Boolean(value);
                return;
            }
            if (input.type === 'number') {
                const normalized = normalizeNumber(Number(value), input);
                if (normalized === null) {
                    return;
                }
                if (input.step && input.step.includes('.')) {
                    input.value = normalized.toFixed(2);
                    return;
                }
                input.value = Math.round(normalized).toString();
                return;
            }

            input.value = value;
        };

        const evaluateRiskLevel = (input) => {
            const tip = runtimeHelp[input.name];
            if (!tip || !tip.HasRecommendedRange || !tip.HasCautionRange || input.type === 'checkbox') {
                return null;
            }

            const current = parseInputValue(input);
            if (typeof current !== 'number') {
                return null;
            }

            if (current < tip.CautionRangeMin || current > tip.CautionRangeMax) {
                return 'high';
            }
            if (current < tip.RecommendedRangeMin || current > tip.RecommendedRangeMax) {
                return 'medium';
            }

            return 'low';
        };

        const applyRangeState = (input) => {
            const risk = evaluateRiskLevel(input);
            input.classList.remove('settings-outside-range');
            input.classList.remove('settings-caution-range');
            if (risk === 'high') {
                input.classList.add('settings-outside-range');
            } else if (risk === 'medium') {
                input.classList.add('settings-caution-range');
            }

            return risk;
        };

        const updateRiskBadges = (key, risk) => {
            const badges = Array.from(document.querySelectorAll(`[data-help-risk-key="${key}"]`));
            badges.forEach((badge) => {
                badge.classList.remove('help-tip__risk--low');
                badge.classList.remove('help-tip__risk--medium');
                badge.classList.remove('help-tip__risk--high');
                if (risk === 'high') {
                    badge.classList.add('help-tip__risk--high');
                    badge.textContent = 'High';
                } else if (risk === 'medium') {
                    badge.classList.add('help-tip__risk--medium');
                    badge.textContent = 'Medium';
                } else {
                    badge.classList.add('help-tip__risk--low');
                    badge.textContent = 'Low';
                }
            });
        };

        const injectRangeHints = (inputs) => {
            inputs.forEach((input) => {
                const tip = runtimeHelp[input.name];
                if (!tip || !tip.HasRecommendedRange || input.type === 'checkbox') {
                    return;
                }

                const label = input.closest('label');
                const labelHeading = label ? label.querySelector('span') : null;
                if (!labelHeading || labelHeading.querySelector('.settings-range-hint')) {
                    return;
                }

                const badge = document.createElement('span');
                badge.className = 'settings-range-hint';
                badge.textContent = `Safe: ${tip.RecommendedRangeLabel}`;
                labelHeading.appendChild(badge);
            });
        };

        const buildSetRecommendedAction = (entry, inputs) => {
            if (typeof entry.recommendedRaw !== 'number') {
                return null;
            }

            const action = document.createElement('button');
            action.type = 'button';
            action.className = 'settings-risk-warning__action';
            action.textContent = 'Set Recommended';
            action.style.display = 'inline-flex';
            action.style.alignItems = 'center';
            action.style.justifyContent = 'center';
            action.style.borderRadius = '9999px';
            action.style.border = '1px solid rgba(245,158,11,.55)';
            action.style.background = 'rgba(245,158,11,.16)';
            action.style.color = '#fde68a';
            action.style.padding = '4px 10px';
            action.style.fontSize = '11px';
            action.style.fontWeight = '600';
            action.style.whiteSpace = 'nowrap';
            action.addEventListener('click', () => {
                const targetInput = inputs.find((candidate) => candidate.name === entry.key);
                if (!targetInput) {
                    return;
                }
                setInputValue(targetInput, entry.recommendedRaw);
                renderChangePreview(inputs);
                renderRiskWarningState(inputs);
                targetInput.focus();
            });

            return action;
        };

        const buildRiskWarningItem = (entry, message, inputs) => {
            const item = document.createElement('div');
            item.className = 'settings-risk-warning__item';
            item.style.display = 'grid';
            item.style.gridTemplateColumns = 'minmax(0, 1fr) auto';
            item.style.alignItems = 'center';
            item.style.gap = '10px';

            const text = document.createElement('div');
            text.className = 'settings-risk-warning__item-text';
            text.textContent = message;
            item.appendChild(text);

            const action = buildSetRecommendedAction(entry, inputs);
            if (action) {
                item.appendChild(action);
            }

            return item;
        };

        const renderRiskWarningState = (inputs) => {
            const highEntries = [];
            const mediumEntries = [];

            inputs.forEach((input) => {
                if (input.type !== 'number') {
                    return;
                }
                const tip = runtimeHelp[input.name];
                if (!tip || !tip.HasRecommendedRange || !tip.HasCautionRange) {
                    return;
                }

                const risk = applyRangeState(input);
                updateRiskBadges(input.name, risk);

                if (risk === null) {
                    return;
                }

                const current = parseInputValue(input);
                const hasRecommended = Object.prototype.hasOwnProperty.call(defaultSettings, input.name);
                const recommendedRaw = hasRecommended ? defaultSettings[input.name] : null;
                const entry = {
                    key: input.name,
                    title: tip.Title,
                    value: formatValue(input, current),
                    safe: tip.RecommendedRangeLabel,
                    caution: tip.CautionRangeLabel,
                    recommendedRaw: recommendedRaw,
                    recommendedLabel: typeof recommendedRaw === 'number' ? formatValue(input, recommendedRaw) : '',
                };

                if (risk === 'high') {
                    highEntries.push(entry);
                } else if (risk === 'medium') {
                    mediumEntries.push(entry);
                }
            });

            if (runtimeSaveButton) {
                runtimeSaveButton.disabled = highEntries.length > 0;
            }

            if (!riskWarningContainer || !riskWarningTitle || !riskWarningMeta || !riskWarningList) {
                return;
            }

            if (highEntries.length > 0) {
                riskWarningContainer.classList.remove('hidden');
                riskWarningContainer.classList.add('settings-risk-warning--high');
                riskWarningContainer.classList.remove('settings-risk-warning--medium');
                riskWarningTitle.textContent = 'Unsafe values detected';
                riskWarningMeta.textContent = 'Save is blocked. Move these fields into caution range (prefer safe range).';
                riskWarningList.innerHTML = '';
                highEntries.forEach((entry) => {
                    const message = `${entry.title}: ${entry.value} (Safe: ${entry.safe}; Caution: ${entry.caution}; Recommended: ${entry.recommendedLabel})`;
                    riskWarningList.appendChild(buildRiskWarningItem(entry, message, inputs));
                });
                return;
            }

            if (mediumEntries.length > 0) {
                riskWarningContainer.classList.remove('hidden');
                riskWarningContainer.classList.add('settings-risk-warning--medium');
                riskWarningContainer.classList.remove('settings-risk-warning--high');
                riskWarningTitle.textContent = 'Outside recommended range';
                riskWarningMeta.textContent = 'Save is allowed, but review values before applying.';
                riskWarningList.innerHTML = '';
                mediumEntries.slice(0, 6).forEach((entry) => {
                    const message = `${entry.title}: ${entry.value} (Safe: ${entry.safe}; Recommended: ${entry.recommendedLabel})`;
                    riskWarningList.appendChild(buildRiskWarningItem(entry, message, inputs));
                });
                return;
            }

            riskWarningContainer.classList.add('hidden');
            riskWarningContainer.classList.remove('settings-risk-warning--high');
            riskWarningContainer.classList.remove('settings-risk-warning--medium');
            riskWarningList.innerHTML = '';
        };

        const summarizeChangeEffect = (tip, previous, next) => {
            if (!tip) {
                return '';
            }
            if (tip.ChangeKind === 'toggle') {
                return next ? tip.ChangeUp : tip.ChangeDown;
            }
            if (tip.ChangeKind === 'numeric') {
                if (typeof previous !== 'number' || typeof next !== 'number') {
                    return tip.ChangeUp;
                }
                return next >= previous ? tip.ChangeUp : tip.ChangeDown;
            }

            return tip.ChangeUp;
        };

        const sameValue = (a, b) => {
            if (typeof a === 'number' && typeof b === 'number') {
                return Math.abs(a - b) < 0.0001;
            }
            return a === b;
        };

        const buildPresets = (defaults) => {
            const balanced = { ...defaults };

            const conservative = { ...defaults };
            conservative.policy_canary_autopilot_enabled = false;
            conservative.alert_error_rate_threshold = defaults.alert_error_rate_threshold * 0.85;
            conservative.quarantine_error_rate_threshold = defaults.quarantine_error_rate_threshold * 0.85;
            conservative.provider_tempfail_warn_rate = defaults.provider_tempfail_warn_rate * 0.9;
            conservative.provider_tempfail_critical_rate = defaults.provider_tempfail_critical_rate * 0.9;
            conservative.provider_reject_warn_rate = defaults.provider_reject_warn_rate * 0.9;
            conservative.provider_reject_critical_rate = defaults.provider_reject_critical_rate * 0.9;
            conservative.provider_unknown_warn_rate = defaults.provider_unknown_warn_rate * 0.9;
            conservative.provider_unknown_critical_rate = defaults.provider_unknown_critical_rate * 0.9;
            conservative.autoscale_canary_percent = Math.min(defaults.autoscale_canary_percent, 50);
            conservative.policy_canary_required_health_windows = defaults.policy_canary_required_health_windows + 1;
            conservative.policy_canary_unknown_regression_threshold = defaults.policy_canary_unknown_regression_threshold * 0.9;
            conservative.policy_canary_tempfail_recovery_drop_threshold = defaults.policy_canary_tempfail_recovery_drop_threshold * 0.9;
            conservative.policy_canary_policy_block_spike_threshold = defaults.policy_canary_policy_block_spike_threshold * 0.9;

            const aggressive = { ...defaults };
            aggressive.policy_canary_autopilot_enabled = true;
            aggressive.alert_error_rate_threshold = defaults.alert_error_rate_threshold * 1.2;
            aggressive.quarantine_error_rate_threshold = defaults.quarantine_error_rate_threshold * 1.15;
            aggressive.alert_check_interval_seconds = defaults.alert_check_interval_seconds * 0.8;
            aggressive.autoscale_interval_seconds = defaults.autoscale_interval_seconds * 0.75;
            aggressive.autoscale_cooldown_seconds = defaults.autoscale_cooldown_seconds * 0.8;
            aggressive.autoscale_canary_percent = Math.max(defaults.autoscale_canary_percent, 75);
            aggressive.autoscale_max_desired = defaults.autoscale_max_desired + 2;
            aggressive.policy_canary_required_health_windows = Math.max(1, defaults.policy_canary_required_health_windows - 1);

            return { conservative, balanced, aggressive };
        };

        const renderChangePreview = (inputs, presetName = '') => {
            if (!previewContainer || !previewMeta || !previewList) {
                return;
            }

            const entries = [];
            inputs.forEach((input) => {
                const key = input.name;
                const previous = baselineSettings[key];
                const next = parseInputValue(input);
                if (next === null || sameValue(previous, next)) {
                    return;
                }

                const tip = runtimeHelp[key];
                entries.push({
                    name: tip ? tip.Title : key,
                    before: formatValue(input, previous),
                    after: formatValue(input, next),
                    effect: summarizeChangeEffect(tip, previous, next),
                });
            });

            if (entries.length === 0) {
                previewContainer.classList.add('hidden');
                previewMeta.textContent = 'No unsaved changes.';
                previewList.innerHTML = '';
                return;
            }

            previewContainer.classList.remove('hidden');
            const presetText = presetName ? `Preset: ${presetName}. ` : '';
            previewMeta.textContent = `${presetText}${entries.length} pending change(s).`;
            previewList.innerHTML = '';
            entries.slice(0, 8).forEach((entry) => {
                const item = document.createElement('div');
                item.className = 'settings-change-preview__item';

                const name = document.createElement('div');
                name.className = 'settings-change-preview__name';
                name.textContent = `${entry.name}: ${entry.before} → ${entry.after}`;

                const effect = document.createElement('div');
                effect.className = 'settings-change-preview__effect';
                effect.textContent = entry.effect;

                item.appendChild(name);
                item.appendChild(effect);
                previewList.appendChild(item);
            });
        };

        if (runtimeSettingsForm) {
            const runtimeInputs = Array.from(runtimeSettingsForm.querySelectorAll('input[name]'));
            const presets = buildPresets(defaultSettings);
            let activePreset = '';

            injectRangeHints(runtimeInputs);
            runtimeInputs.forEach((input) => {
                const eventName = input.type === 'checkbox' ? 'change' : 'input';
                input.addEventListener(eventName, () => {
                    activePreset = '';
                    presetButtons.forEach((button) => button.classList.remove('is-active'));
                    renderChangePreview(runtimeInputs);
                    renderRiskWarningState(runtimeInputs);
                });
            });

            presetButtons.forEach((button) => {
                button.addEventListener('click', () => {
                    const presetName = button.getAttribute('data-settings-preset');
                    const preset = presetName ? presets[presetName] : null;
                    if (!preset) {
                        return;
                    }

                    runtimeInputs.forEach((input) => {
                        if (Object.prototype.hasOwnProperty.call(preset, input.name)) {
                            setInputValue(input, preset[input.name]);
                        }
                    });

                    activePreset = presetName;
                    presetButtons.forEach((item) => item.classList.toggle('is-active', item === button));
                    renderChangePreview(runtimeInputs, activePreset);
                    renderRiskWarningState(runtimeInputs);
                });
            });

            if (setAllRecommendedButton) {
                setAllRecommendedButton.addEventListener('click', () => {
                    runtimeInputs.forEach((input) => {
                        if (Object.prototype.hasOwnProperty.call(defaultSettings, input.name)) {
                            setInputValue(input, defaultSettings[input.name]);
                        }
                    });

                    activePreset = '';
                    presetButtons.forEach((button) => button.classList.remove('is-active'));
                    renderChangePreview(runtimeInputs);
                    renderRiskWarningState(runtimeInputs);
                });
            }

            renderChangePreview(runtimeInputs, activePreset);
            renderRiskWarningState(runtimeInputs);

            runtimeSettingsForm.addEventListener('submit', (event) => {
                renderRiskWarningState(runtimeInputs);
                if (runtimeSaveButton && runtimeSaveButton.disabled) {
                    event.preventDefault();
                }
            });
        }

        if (!versionSelect || !promoteButton) {
            return;
        }

        const syncState = () => {
            const selected = versionSelect.options[versionSelect.selectedIndex];
            const isValid = selected && selected.getAttribute('data-validation') === 'valid';
            promoteButton.disabled = !isValid;
            if (hint) {
                hint.textContent = isValid
                    ? 'Selected version is validated and ready for promote.'
                    : 'Only versions with validation status valid can be promoted.';
            }
        };

        versionSelect.addEventListener('change', syncState);
        syncState();
    });
</script>
{{ end }}
