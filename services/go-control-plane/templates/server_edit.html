{{ define "server_edit" }}
<section class="space-y-4">
    <section class="rounded-2xl border border-slate-800 bg-slate-900/60 p-6">
        <div class="flex flex-wrap items-center justify-between gap-3">
            <div class="space-y-1">
                <h2 class="text-lg font-semibold">Edit Server · {{ .Server.Name }}</h2>
                <p class="text-sm text-slate-400">Update server metadata and control-plane connection settings.</p>
            </div>
            <div class="flex flex-wrap gap-2">
                <a href="{{ .BasePath }}/servers/{{ .Server.ID }}" class="rounded-full bg-slate-800 px-3 py-1 text-xs text-slate-200 hover:bg-slate-700">Back to Manage</a>
                <a href="{{ .BasePath }}/servers" class="rounded-full bg-slate-800 px-3 py-1 text-xs text-slate-200 hover:bg-slate-700">Back to Inventory</a>
            </div>
        </div>

        {{ if .Notice }}
            <div class="mt-4 rounded-xl border border-emerald-500/40 bg-emerald-500/10 px-4 py-3 text-sm text-emerald-200">{{ .Notice }}</div>
        {{ end }}
        {{ if .Error }}
            <div class="mt-4 rounded-xl border border-red-500/40 bg-red-500/10 px-4 py-3 text-sm text-red-200">{{ .Error }}</div>
        {{ end }}

        <form method="POST" action="{{ .BasePath }}/servers/{{ .Server.ID }}/edit" class="mt-6 grid gap-3 md:grid-cols-2">
            <input type="hidden" name="return_to" value="server_edit" />
            <input type="hidden" name="return_server_id" value="{{ .Server.ID }}" />

            <label class="space-y-1 text-xs text-slate-400">
                <span>Name</span>
                <input name="name" value="{{ .Server.Name }}" required class="w-full rounded-lg border border-slate-700 bg-slate-900 px-3 py-2 text-sm text-slate-100" />
            </label>
            <label class="space-y-1 text-xs text-slate-400">
                <span>IP Address</span>
                <input name="ip_address" value="{{ .Server.IPAddress }}" required class="w-full rounded-lg border border-slate-700 bg-slate-900 px-3 py-2 text-sm text-slate-100" />
            </label>

            <label class="space-y-1 text-xs text-slate-400">
                <span>Environment</span>
                <input name="environment" value="{{ .Server.Environment }}" class="w-full rounded-lg border border-slate-700 bg-slate-900 px-3 py-2 text-sm text-slate-100" />
            </label>
            <label class="space-y-1 text-xs text-slate-400">
                <span>Region</span>
                <input name="region" value="{{ .Server.Region }}" class="w-full rounded-lg border border-slate-700 bg-slate-900 px-3 py-2 text-sm text-slate-100" />
            </label>

            <label class="space-y-1 text-xs text-slate-400">
                <span>HELO Name</span>
                <input name="helo_name" value="{{ .Server.HeloName }}" class="w-full rounded-lg border border-slate-700 bg-slate-900 px-3 py-2 text-sm text-slate-100" />
            </label>
            <label class="space-y-1 text-xs text-slate-400">
                <span>MAIL FROM</span>
                <input name="mail_from_address" type="email" value="{{ .Server.MailFromAddress }}" class="w-full rounded-lg border border-slate-700 bg-slate-900 px-3 py-2 text-sm text-slate-100" />
            </label>

            <label class="space-y-1 text-xs text-slate-400">
                <span>Verifier Domain</span>
                <select name="verifier_domain_id" class="w-full rounded-lg border border-slate-700 bg-slate-900 px-3 py-2 text-sm text-slate-100">
                    <option value="">Select active domain</option>
                    {{ range .VerifierDomains }}
                        <option value="{{ .ID }}" {{ if eq $.Server.VerifierDomainID .ID }}selected{{ end }}>{{ .Domain }}</option>
                    {{ end }}
                </select>
            </label>
            <label class="space-y-1 text-xs text-slate-400">
                <span>Worker Pool</span>
                <select name="worker_pool_id" required class="w-full rounded-lg border border-slate-700 bg-slate-900 px-3 py-2 text-sm text-slate-100">
                    <option value="">Select pool</option>
                    {{ range .Pools }}
                        {{ if .IsActive }}
                            <option value="{{ .ID }}" {{ if eq $.Server.WorkerPoolID .ID }}selected{{ end }}>{{ .Name }} ({{ .Slug }}){{ if .IsDefault }} · default{{ end }}</option>
                        {{ end }}
                    {{ end }}
                </select>
                <a href="{{ $.BasePath }}/pools" class="text-[11px] text-cyan-200 underline">View pool policy</a>
            </label>
            <label class="space-y-1 text-xs text-slate-400">
                <span>Max Concurrency</span>
                <input name="max_concurrency" type="number" min="1" value="{{ if gt .Server.MaxConcurrency 0 }}{{ .Server.MaxConcurrency }}{{ end }}" class="w-full rounded-lg border border-slate-700 bg-slate-900 px-3 py-2 text-sm text-slate-100" />
            </label>

            <label class="space-y-1 text-xs text-slate-400">
                <span>Process control mode</span>
                <select name="process_control_mode" class="w-full rounded-lg border border-slate-700 bg-slate-900 px-3 py-2 text-sm text-slate-100">
                    <option value="control_plane_only" {{ if ne .Server.ProcessControlMode "agent_systemd" }}selected{{ end }}>Control-plane only</option>
                    <option value="agent_systemd" {{ if eq .Server.ProcessControlMode "agent_systemd" }}selected{{ end }}>Agent (systemd)</option>
                </select>
            </label>
            <label class="space-y-1 text-xs text-slate-400">
                <span>Agent base URL</span>
                <input name="agent_base_url" value="{{ .Server.AgentBaseURL }}" class="w-full rounded-lg border border-slate-700 bg-slate-900 px-3 py-2 text-sm text-slate-100" />
            </label>

            <label class="space-y-1 text-xs text-slate-400">
                <span>Agent service name</span>
                <input name="agent_service_name" value="{{ .Server.AgentServiceName }}" class="w-full rounded-lg border border-slate-700 bg-slate-900 px-3 py-2 text-sm text-slate-100" />
            </label>
            <label class="space-y-1 text-xs text-slate-400">
                <span>Agent timeout (seconds)</span>
                <input name="agent_timeout_seconds" type="number" min="2" max="30" value="{{ if gt .Server.AgentTimeoutSeconds 0 }}{{ .Server.AgentTimeoutSeconds }}{{ else }}8{{ end }}" class="w-full rounded-lg border border-slate-700 bg-slate-900 px-3 py-2 text-sm text-slate-100" />
            </label>

            <label class="md:col-span-2 space-y-1 text-xs text-slate-400">
                <span>Notes</span>
                <textarea name="notes" rows="3" class="w-full rounded-lg border border-slate-700 bg-slate-900 px-3 py-2 text-sm text-slate-100">{{ .Server.Notes }}</textarea>
            </label>

            <label class="flex items-center gap-2 text-xs text-slate-300">
                <input type="checkbox" name="is_active" value="1" {{ if .Server.IsActive }}checked{{ end }} class="h-4 w-4 rounded border-slate-600 bg-slate-900 text-amber-500" />
                Enabled
            </label>
            <label class="flex items-center gap-2 text-xs text-slate-300">
                <input type="checkbox" name="drain_mode" value="1" {{ if .Server.DrainMode }}checked{{ end }} class="h-4 w-4 rounded border-slate-600 bg-slate-900 text-amber-500" />
                Drain mode
            </label>
            <label class="flex items-center gap-2 text-xs text-slate-300">
                <input type="checkbox" name="agent_enabled" value="1" {{ if .Server.AgentEnabled }}checked{{ end }} class="h-4 w-4 rounded border-slate-600 bg-slate-900 text-amber-500" />
                Agent control enabled
            </label>
            <label class="space-y-1 text-xs text-slate-400">
                <span>Verify agent TLS</span>
                <select name="agent_verify_tls" class="w-full rounded-lg border border-slate-700 bg-slate-900 px-3 py-2 text-sm text-slate-100">
                    <option value="1" {{ if .Server.AgentVerifyTLS }}selected{{ end }}>Enabled</option>
                    <option value="0" {{ if not .Server.AgentVerifyTLS }}selected{{ end }}>Disabled</option>
                </select>
            </label>

            <div class="md:col-span-2 mt-1">
                <button type="submit" class="rounded-full bg-amber-500 px-4 py-2 text-xs font-semibold text-slate-900 hover:bg-amber-400">Save Server</button>
            </div>
        </form>
    </section>
</section>
{{ end }}
