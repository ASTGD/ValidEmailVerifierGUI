{{ define "pools" }}
<section class="space-y-4">
    <section class="rounded-2xl border border-slate-800 bg-slate-900/60 p-6">
        <div class="space-y-1">
            <h2 class="text-lg font-semibold">Pools</h2>
            <p class="text-sm text-slate-400">First-class server groups with provider policy profiles and runtime capacity.</p>
            <p class="text-xs text-slate-500">Assign pools from Provisioning or Server Edit. Pools control both routing behavior and worker runtime posture.</p>
        </div>

        {{ if .Notice }}
            <div class="mt-4 rounded-xl border border-emerald-500/40 bg-emerald-500/10 px-4 py-3 text-sm text-emerald-200">{{ .Notice }}</div>
        {{ end }}
        {{ if .Error }}
            <div class="mt-4 rounded-xl border border-red-500/40 bg-red-500/10 px-4 py-3 text-sm text-red-200">{{ .Error }}</div>
        {{ end }}

        {{ if not .Configured }}
            <div class="mt-6 rounded-xl border border-red-500/40 bg-red-500/10 px-4 py-3 text-sm text-red-200">
                Pools management is unavailable. Configure <code class="text-red-100">LARAVEL_INTERNAL_API_BASE_URL</code>
                and <code class="text-red-100">LARAVEL_INTERNAL_API_TOKEN</code>.
            </div>
        {{ else }}
            <div class="mt-6 grid gap-4 lg:grid-cols-2">
                <section class="rounded-xl border border-slate-800 bg-slate-950/60 p-4">
                    <h3 class="text-sm font-semibold text-slate-100">Create Pool</h3>
                    <form method="POST" action="{{ .BasePath }}/pools" class="mt-3 grid gap-3">
                        <div class="grid gap-3 md:grid-cols-2">
                            <label class="space-y-1 text-xs text-slate-400">
                                <span>Slug</span>
                                <input name="slug" required placeholder="gmail-lowhit" class="w-full rounded-lg border border-slate-700 bg-slate-900 px-3 py-2 text-sm text-slate-100" />
                            </label>
                            <label class="space-y-1 text-xs text-slate-400">
                                <span>Name</span>
                                <input name="name" required placeholder="Gmail Low Hit Pool" class="w-full rounded-lg border border-slate-700 bg-slate-900 px-3 py-2 text-sm text-slate-100" />
                            </label>
                        </div>
                        <label class="space-y-1 text-xs text-slate-400">
                            <span>Description</span>
                            <input name="description" class="w-full rounded-lg border border-slate-700 bg-slate-900 px-3 py-2 text-sm text-slate-100" />
                        </label>
                        <div class="grid gap-3 md:grid-cols-2">
                            <label class="space-y-1 text-xs text-slate-400">
                                <span>Generic Profile</span>
                                <select name="provider_profile_generic" class="w-full rounded-lg border border-slate-700 bg-slate-900 px-3 py-2 text-sm text-slate-100">
                                    {{ range .ProfileOptions }}
                                        <option value="{{ .Key }}">{{ .Label }}</option>
                                    {{ end }}
                                </select>
                            </label>
                            <label class="space-y-1 text-xs text-slate-400">
                                <span>Gmail Profile</span>
                                <select name="provider_profile_gmail" class="w-full rounded-lg border border-slate-700 bg-slate-900 px-3 py-2 text-sm text-slate-100">
                                    {{ range .ProfileOptions }}
                                        <option value="{{ .Key }}">{{ .Label }}</option>
                                    {{ end }}
                                </select>
                            </label>
                            <label class="space-y-1 text-xs text-slate-400">
                                <span>Microsoft Profile</span>
                                <select name="provider_profile_microsoft" class="w-full rounded-lg border border-slate-700 bg-slate-900 px-3 py-2 text-sm text-slate-100">
                                    {{ range .ProfileOptions }}
                                        <option value="{{ .Key }}">{{ .Label }}</option>
                                    {{ end }}
                                </select>
                            </label>
                            <label class="space-y-1 text-xs text-slate-400">
                                <span>Yahoo Profile</span>
                                <select name="provider_profile_yahoo" class="w-full rounded-lg border border-slate-700 bg-slate-900 px-3 py-2 text-sm text-slate-100">
                                    {{ range .ProfileOptions }}
                                        <option value="{{ .Key }}">{{ .Label }}</option>
                                    {{ end }}
                                </select>
                            </label>
                        </div>
                        <div class="flex flex-wrap items-center gap-3 text-xs text-slate-300">
                            <label class="flex items-center gap-2">
                                <input type="checkbox" name="is_active" value="1" checked class="h-4 w-4 rounded border-slate-600 bg-slate-900 text-amber-500" />
                                Active
                            </label>
                            <label class="flex items-center gap-2">
                                <input type="checkbox" name="is_default" value="1" class="h-4 w-4 rounded border-slate-600 bg-slate-900 text-amber-500" />
                                Set as default
                            </label>
                        </div>
                        <div>
                            <button type="submit" class="rounded-full bg-amber-500 px-4 py-2 text-xs font-semibold text-slate-900 hover:bg-amber-400">Create Pool</button>
                        </div>
                    </form>
                </section>

                <section class="rounded-xl border border-slate-800 bg-slate-950/60 p-4">
                    <h3 class="text-sm font-semibold text-slate-100">{{ if .EditPool }}Edit Pool{{ else }}Edit Pool{{ end }}</h3>
                    {{ if .EditPool }}
                        <form method="POST" action="{{ .BasePath }}/pools/{{ .EditPool.ID }}" class="mt-3 grid gap-3">
                            <div class="grid gap-3 md:grid-cols-2">
                                <label class="space-y-1 text-xs text-slate-400">
                                    <span>Slug</span>
                                    <input name="slug" required value="{{ .EditPool.Slug }}" class="w-full rounded-lg border border-slate-700 bg-slate-900 px-3 py-2 text-sm text-slate-100" />
                                </label>
                                <label class="space-y-1 text-xs text-slate-400">
                                    <span>Name</span>
                                    <input name="name" required value="{{ .EditPool.Name }}" class="w-full rounded-lg border border-slate-700 bg-slate-900 px-3 py-2 text-sm text-slate-100" />
                                </label>
                            </div>
                            <label class="space-y-1 text-xs text-slate-400">
                                <span>Description</span>
                                <input name="description" value="{{ .EditPool.Description }}" class="w-full rounded-lg border border-slate-700 bg-slate-900 px-3 py-2 text-sm text-slate-100" />
                            </label>
                            <div class="grid gap-3 md:grid-cols-2">
                                <label class="space-y-1 text-xs text-slate-400">
                                    <span>Generic Profile</span>
                                    <select name="provider_profile_generic" class="w-full rounded-lg border border-slate-700 bg-slate-900 px-3 py-2 text-sm text-slate-100">
                                        {{ $current := index .EditPool.ProviderProfiles "generic" }}
                                        {{ range $.ProfileOptions }}
                                            <option value="{{ .Key }}" {{ if eq $current .Key }}selected{{ end }}>{{ .Label }}</option>
                                        {{ end }}
                                    </select>
                                </label>
                                <label class="space-y-1 text-xs text-slate-400">
                                    <span>Gmail Profile</span>
                                    <select name="provider_profile_gmail" class="w-full rounded-lg border border-slate-700 bg-slate-900 px-3 py-2 text-sm text-slate-100">
                                        {{ $current := index .EditPool.ProviderProfiles "gmail" }}
                                        {{ range $.ProfileOptions }}
                                            <option value="{{ .Key }}" {{ if eq $current .Key }}selected{{ end }}>{{ .Label }}</option>
                                        {{ end }}
                                    </select>
                                </label>
                                <label class="space-y-1 text-xs text-slate-400">
                                    <span>Microsoft Profile</span>
                                    <select name="provider_profile_microsoft" class="w-full rounded-lg border border-slate-700 bg-slate-900 px-3 py-2 text-sm text-slate-100">
                                        {{ $current := index .EditPool.ProviderProfiles "microsoft" }}
                                        {{ range $.ProfileOptions }}
                                            <option value="{{ .Key }}" {{ if eq $current .Key }}selected{{ end }}>{{ .Label }}</option>
                                        {{ end }}
                                    </select>
                                </label>
                                <label class="space-y-1 text-xs text-slate-400">
                                    <span>Yahoo Profile</span>
                                    <select name="provider_profile_yahoo" class="w-full rounded-lg border border-slate-700 bg-slate-900 px-3 py-2 text-sm text-slate-100">
                                        {{ $current := index .EditPool.ProviderProfiles "yahoo" }}
                                        {{ range $.ProfileOptions }}
                                            <option value="{{ .Key }}" {{ if eq $current .Key }}selected{{ end }}>{{ .Label }}</option>
                                        {{ end }}
                                    </select>
                                </label>
                            </div>
                            <div class="flex flex-wrap items-center gap-3 text-xs text-slate-300">
                                <label class="flex items-center gap-2">
                                    <input type="checkbox" name="is_active" value="1" {{ if .EditPool.IsActive }}checked{{ end }} class="h-4 w-4 rounded border-slate-600 bg-slate-900 text-amber-500" />
                                    Active
                                </label>
                                <label class="flex items-center gap-2">
                                    <input type="checkbox" name="is_default" value="1" {{ if .EditPool.IsDefault }}checked{{ end }} class="h-4 w-4 rounded border-slate-600 bg-slate-900 text-amber-500" />
                                    Default
                                </label>
                            </div>
                            <div class="flex flex-wrap gap-2">
                                <button type="submit" class="rounded-full bg-cyan-500 px-4 py-2 text-xs font-semibold text-slate-900 hover:bg-cyan-400">Save Pool</button>
                                <a href="{{ $.BasePath }}/pools" class="rounded-full bg-slate-800 px-4 py-2 text-xs font-semibold text-slate-200 hover:bg-slate-700">Cancel</a>
                            </div>
                        </form>
                    {{ else }}
                        <p class="mt-3 text-sm text-slate-400">Select a pool from the table below to edit.</p>
                    {{ end }}
                </section>
            </div>

            <div class="mt-6 overflow-x-auto">
                <table class="w-full text-left text-sm">
                    <thead class="text-xs uppercase text-slate-500">
                        <tr>
                            <th class="py-2">Pool</th>
                            <th class="py-2">Policy Summary</th>
                            <th class="py-2">Linked Servers</th>
                            <th class="py-2">Runtime</th>
                            <th class="py-2">Actions</th>
                        </tr>
                    </thead>
                    <tbody class="divide-y divide-slate-800">
                        {{ range .Rows }}
                            <tr>
                                <td class="py-3 align-top">
                                    <p class="font-medium text-slate-100">{{ .Pool.Name }}</p>
                                    <p class="mt-1 text-xs text-slate-400">{{ .Pool.Slug }}</p>
                                    <div class="mt-1 flex flex-wrap gap-2 text-xs">
                                        {{ if .Pool.IsDefault }}<span class="rounded-full bg-amber-500/20 px-2 py-1 text-amber-200">default</span>{{ end }}
                                        {{ if .Pool.IsActive }}<span class="rounded-full bg-emerald-500/20 px-2 py-1 text-emerald-300">active</span>{{ else }}<span class="rounded-full bg-slate-800 px-2 py-1 text-slate-300">archived</span>{{ end }}
                                    </div>
                                </td>
                                <td class="py-3 align-top text-xs text-slate-300">
                                    <p>generic: {{ index .Pool.ProviderProfiles "generic" }}</p>
                                    <p>gmail: {{ index .Pool.ProviderProfiles "gmail" }}</p>
                                    <p>microsoft: {{ index .Pool.ProviderProfiles "microsoft" }}</p>
                                    <p>yahoo: {{ index .Pool.ProviderProfiles "yahoo" }}</p>
                                </td>
                                <td class="py-3 align-top text-sm text-slate-300">{{ .Pool.LinkedServersCount }}</td>
                                <td class="py-3 align-top text-xs text-slate-300">
                                    <p>online {{ .RuntimeOnline }}</p>
                                    <form method="POST" action="{{ $.BasePath }}/pools/{{ .Pool.Slug }}/scale" class="mt-2 flex items-center gap-2">
                                        <label for="desired-{{ .Pool.ID }}" class="text-slate-400">desired</label>
                                        <input id="desired-{{ .Pool.ID }}" name="desired" type="number" min="0" value="{{ .RuntimeDesired }}" class="w-20 rounded-lg border border-slate-700 bg-slate-900 px-2 py-1 text-xs text-slate-100" />
                                        <button type="submit" class="rounded-full bg-slate-800 px-3 py-1 text-xs text-slate-200 hover:bg-slate-700">Update</button>
                                    </form>
                                </td>
                                <td class="py-3 align-top">
                                    <div class="flex flex-wrap gap-2">
                                        <a href="{{ $.BasePath }}/pools?edit_pool_id={{ .Pool.ID }}" class="rounded-full bg-slate-800 px-3 py-1 text-xs text-slate-200 hover:bg-slate-700">Edit</a>
                                        {{ if not .Pool.IsDefault }}
                                            <form method="POST" action="{{ $.BasePath }}/pools/{{ .Pool.ID }}/set-default">
                                                <button type="submit" class="rounded-full bg-amber-500/20 px-3 py-1 text-xs text-amber-200 hover:bg-amber-500/30">Set Default</button>
                                            </form>
                                        {{ end }}
                                        {{ if and .Pool.IsActive (not .Pool.IsDefault) }}
                                            <form method="POST" action="{{ $.BasePath }}/pools/{{ .Pool.ID }}/archive" data-confirm-title="Archive Pool" data-confirm-message="Archive pool {{ .Pool.Name }}?">
                                                <button type="submit" class="rounded-full bg-red-500/20 px-3 py-1 text-xs text-red-300 hover:bg-red-500/30">Archive</button>
                                            </form>
                                        {{ end }}
                                    </div>
                                </td>
                            </tr>
                        {{ else }}
                            <tr>
                                <td class="py-6 text-center text-slate-400" colspan="5">No pools found.</td>
                            </tr>
                        {{ end }}
                    </tbody>
                </table>
            </div>
        {{ end }}
    </section>
</section>
{{ end }}
