{{ define "alerts" }}
<section class="rounded-2xl border border-slate-800 bg-slate-900/60 p-6">
    <div class="flex items-center justify-between">
        <div>
            <h2 class="text-lg font-semibold">Recent Alerts</h2>
            <p class="text-sm text-slate-400">Latest records from MySQL `go_alerts`.</p>
        </div>
        {{ if .HasStorage }}
        <span id="alerts-record-count" class="text-xs text-slate-400">{{ .AlertCount }} records</span>
        {{ end }}
    </div>

    {{ if not .HasStorage }}
    <div class="mt-4 rounded-xl border border-amber-500/30 bg-amber-500/10 p-4 text-sm text-amber-200">
        MySQL storage is not configured. Set <code>MYSQL_DSN</code> to enable alert persistence and this page.
    </div>
    {{ else }}
    <div class="mt-6 overflow-x-auto">
        <table class="w-full text-left text-sm">
            <thead class="text-xs uppercase text-slate-500">
                <tr>
                    <th class="py-2">Created At</th>
                    <th class="py-2">Type</th>
                    <th class="py-2">Severity</th>
                    <th class="py-2">Message</th>
                    <th class="py-2">Context</th>
                </tr>
            </thead>
            <tbody id="alerts-table-body" class="divide-y divide-slate-800">
                {{ range .Alerts }}
                <tr>
                    <td class="py-3 text-slate-300">{{ formatTimestamp .CreatedAt }}</td>
                    <td class="py-3 font-medium">{{ .Type }}</td>
                    <td class="py-3"><span class="rounded-full px-3 py-1 text-xs {{ severityClass .Severity }}">{{ .Severity }}</span></td>
                    <td class="py-3 text-slate-200">{{ .Message }}</td>
                    <td class="py-3 text-xs text-slate-400">{{ if .Context }}{{ .Context }}{{ else }}-{{ end }}</td>
                </tr>
                {{ else }}
                <tr>
                    <td class="py-6 text-center text-slate-400" colspan="5">No alerts recorded yet.</td>
                </tr>
                {{ end }}
            </tbody>
        </table>
    </div>
    {{ end }}
</section>

<section class="mt-8 rounded-2xl border border-slate-800 bg-slate-900/60 p-6">
    <div class="flex items-center justify-between">
        <div>
            <h2 class="text-lg font-semibold">Incident Timeline</h2>
            <p class="text-sm text-slate-400">Lifecycle view (active + recovered incidents).</p>
        </div>
        <span id="incidents-active-count" class="text-xs text-slate-400">{{ .ActiveIncidentCount }} active</span>
    </div>

    <div class="mt-6 overflow-x-auto">
        <table class="w-full text-left text-sm">
            <thead class="text-xs uppercase text-slate-500">
                <tr>
                    <th class="py-2">Updated At</th>
                    <th class="py-2">Type</th>
                    <th class="py-2">Severity</th>
                    <th class="py-2">Status</th>
                    <th class="py-2">Message</th>
                    <th class="py-2">Context</th>
                </tr>
            </thead>
            <tbody id="incidents-table-body" class="divide-y divide-slate-800">
                {{ range .Incidents }}
                <tr>
                    <td class="py-3 text-slate-300">{{ .UpdatedAt }}</td>
                    <td class="py-3 font-medium">{{ .Type }}</td>
                    <td class="py-3"><span class="rounded-full px-3 py-1 text-xs {{ severityClass .Severity }}">{{ .Severity }}</span></td>
                    <td class="py-3">
                        <span class="rounded-full px-3 py-1 text-xs {{ if eq .Status "active" }}bg-red-500/20 text-red-300{{ else }}bg-emerald-500/20 text-emerald-300{{ end }}">{{ .Status }}</span>
                    </td>
                    <td class="py-3 text-slate-200">{{ .Message }}</td>
                    <td class="py-3 text-xs text-slate-400">{{ if .Context }}{{ toJSON .Context }}{{ else }}-{{ end }}</td>
                </tr>
                {{ else }}
                <tr>
                    <td class="py-6 text-center text-slate-400" colspan="6">No incidents tracked yet.</td>
                </tr>
                {{ end }}
            </tbody>
        </table>
    </div>
</section>

<script defer>
    window.addEventListener('DOMContentLoaded', () => {
        const alertsBody = document.getElementById('alerts-table-body');
        const incidentsBody = document.getElementById('incidents-table-body');
        const alertsCount = document.getElementById('alerts-record-count');
        const activeIncidentsCount = document.getElementById('incidents-active-count');
        const hasStorage = {{ if .HasStorage }}true{{ else }}false{{ end }};
        const pollIntervalSeconds = Math.max(5, Number({{ .PollIntervalSeconds }}) || 30);
        const pollIntervalMs = pollIntervalSeconds * 1000;

        const escapeHtml = (value) => String(value ?? '')
            .replaceAll('&', '&amp;')
            .replaceAll('<', '&lt;')
            .replaceAll('>', '&gt;')
            .replaceAll('"', '&quot;')
            .replaceAll("'", '&#39;');

        const severityClass = (severity) => {
            const normalized = String(severity || '').toLowerCase();
            if (normalized === 'critical') return 'bg-red-500/20 text-red-300';
            if (normalized === 'warning') return 'bg-amber-500/20 text-amber-300';
            return 'bg-slate-800 text-slate-200';
        };

        const statusClass = (status) => {
            const normalized = String(status || '').toLowerCase();
            if (normalized === 'active') return 'bg-red-500/20 text-red-300';
            return 'bg-emerald-500/20 text-emerald-300';
        };

        const formatTimestamp = (value) => {
            if (!value) return '-';
            const parsed = new Date(value);
            if (Number.isNaN(parsed.getTime())) return escapeHtml(value);
            return parsed.toLocaleString();
        };

        const renderAlerts = (records) => {
            if (!alertsBody) return;
            if (!Array.isArray(records) || records.length === 0) {
                alertsBody.innerHTML = '<tr><td class="py-6 text-center text-slate-400" colspan="5">No alerts recorded yet.</td></tr>';
                if (alertsCount) alertsCount.textContent = '0 records';
                return;
            }

            const rows = records.map((record) => `
                <tr>
                    <td class="py-3 text-slate-300">${formatTimestamp(record.created_at)}</td>
                    <td class="py-3 font-medium">${escapeHtml(record.type || '')}</td>
                    <td class="py-3"><span class="rounded-full px-3 py-1 text-xs ${severityClass(record.severity)}">${escapeHtml(record.severity || '')}</span></td>
                    <td class="py-3 text-slate-200">${escapeHtml(record.message || '')}</td>
                    <td class="py-3 text-xs text-slate-400">${escapeHtml(record.context || '-')}</td>
                </tr>
            `);
            alertsBody.innerHTML = rows.join('');
            if (alertsCount) alertsCount.textContent = `${records.length} records`;
        };

        const renderIncidents = (records) => {
            if (!incidentsBody) return;
            if (!Array.isArray(records) || records.length === 0) {
                incidentsBody.innerHTML = '<tr><td class="py-6 text-center text-slate-400" colspan="6">No incidents tracked yet.</td></tr>';
                if (activeIncidentsCount) activeIncidentsCount.textContent = '0 active';
                return;
            }

            const activeCount = records.filter((record) => String(record.status || '').toLowerCase() === 'active').length;
            const rows = records.map((record) => {
                const context = record.context ? JSON.stringify(record.context) : '-';
                return `
                    <tr>
                        <td class="py-3 text-slate-300">${escapeHtml(record.updated_at || '-')}</td>
                        <td class="py-3 font-medium">${escapeHtml(record.type || '')}</td>
                        <td class="py-3"><span class="rounded-full px-3 py-1 text-xs ${severityClass(record.severity)}">${escapeHtml(record.severity || '')}</span></td>
                        <td class="py-3"><span class="rounded-full px-3 py-1 text-xs ${statusClass(record.status)}">${escapeHtml(record.status || '')}</span></td>
                        <td class="py-3 text-slate-200">${escapeHtml(record.message || '')}</td>
                        <td class="py-3 text-xs text-slate-400">${escapeHtml(context)}</td>
                    </tr>
                `;
            });
            incidentsBody.innerHTML = rows.join('');
            if (activeIncidentsCount) activeIncidentsCount.textContent = `${activeCount} active`;
        };

        const refreshAlertsAndIncidents = async () => {
            try {
                const incidentsResponse = await fetch('/api/incidents?include_resolved=1&limit=100', { headers: { 'Accept': 'application/json' } });
                if (incidentsResponse.ok) {
                    const incidentsPayload = await incidentsResponse.json();
                    renderIncidents(incidentsPayload.data);
                }
            } catch (_) {}

            if (!hasStorage) {
                return;
            }

            try {
                const alertsResponse = await fetch('/api/alerts?limit=200', { headers: { 'Accept': 'application/json' } });
                if (!alertsResponse.ok) {
                    return;
                }

                const alertsPayload = await alertsResponse.json();
                renderAlerts(alertsPayload.data);
            } catch (_) {}
        };

        refreshAlertsAndIncidents();
        const intervalId = window.setInterval(refreshAlertsAndIncidents, pollIntervalMs);
        window.addEventListener('beforeunload', () => window.clearInterval(intervalId));
    });
</script>
{{ end }}
