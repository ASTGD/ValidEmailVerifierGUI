{{ define "server_manage" }}
<section class="space-y-4">
    <section class="rounded-2xl border border-slate-800 bg-slate-900/60 p-6">
        <div class="flex flex-wrap items-center justify-between gap-3">
            <div class="space-y-1">
                <h2 class="text-lg font-semibold">Manage Server · {{ .Server.Name }}</h2>
                <p class="text-sm text-slate-400">Diagnostics and infrastructure control for this server record.</p>
            </div>
            <div class="flex flex-wrap gap-2">
                <a href="{{ .BasePath }}/servers" class="rounded-full bg-slate-800 px-3 py-1 text-xs text-slate-200 hover:bg-slate-700">Back to Inventory</a>
                <a href="{{ .BasePath }}/provisioning?mode=existing&server_id={{ .Server.ID }}&bundle_server_id={{ .Server.ID }}" class="rounded-full bg-cyan-500/20 px-3 py-1 text-xs text-cyan-200 hover:bg-cyan-500/30">Open Provisioning</a>
                <a href="{{ .BasePath }}/servers/{{ .Server.ID }}/edit" class="rounded-full bg-amber-500 px-3 py-1 text-xs font-semibold text-slate-900 hover:bg-amber-400">Edit Server</a>
            </div>
        </div>

        {{ if .Notice }}
            <div class="mt-4 rounded-xl border border-emerald-500/40 bg-emerald-500/10 px-4 py-3 text-sm text-emerald-200">{{ .Notice }}</div>
        {{ end }}
        {{ if .Error }}
            <div class="mt-4 rounded-xl border border-red-500/40 bg-red-500/10 px-4 py-3 text-sm text-red-200">{{ .Error }}</div>
        {{ end }}

        <div class="mt-6 grid gap-4 lg:grid-cols-2">
            <section class="rounded-xl border border-slate-800 bg-slate-950/60 p-4">
                <h3 class="text-sm font-semibold text-slate-100">State Diagnostics</h3>
                <dl class="mt-3 space-y-3 text-sm text-slate-300">
                    <div>
                        <dt class="text-xs uppercase tracking-wide text-slate-500">Process</dt>
                        <dd class="mt-1">
                            <span class="rounded-full px-3 py-1 text-xs {{ if eq .Server.ProcessState "running" }}bg-emerald-500/20 text-emerald-300{{ else if or (eq .Server.ProcessState "starting") (eq .Server.ProcessState "stopping") }}bg-amber-500/20 text-amber-200{{ else if eq .Server.ProcessState "stopped" }}bg-red-500/20 text-red-300{{ else }}bg-slate-800 text-slate-300{{ end }}">{{ .Server.ProcessState }}</span>
                        </dd>
                    </div>
                    <div>
                        <dt class="text-xs uppercase tracking-wide text-slate-500">Database Sync</dt>
                        <dd class="mt-1">
                            <span class="rounded-full px-3 py-1 text-xs {{ if eq .Server.HeartbeatState "healthy" }}bg-emerald-500/20 text-emerald-300{{ else if eq .Server.HeartbeatState "stale" }}bg-amber-500/20 text-amber-200{{ else }}bg-slate-800 text-slate-300{{ end }}">{{ if eq .Server.HeartbeatState "healthy" }}synced{{ else if eq .Server.HeartbeatState "stale" }}delayed{{ else }}no data{{ end }}{{ if .Server.HeartbeatAgeText }} · {{ .Server.HeartbeatAgeText }}{{ end }}</span>
                            <p class="mt-1 text-xs text-slate-500">{{ if .Server.LastHeartbeatAt }}{{ .Server.LastHeartbeatAt }}{{ else }}No database sync timestamp yet.{{ end }}</p>
                        </dd>
                    </div>
                    <div>
                        <dt class="text-xs uppercase tracking-wide text-slate-500">Assigned Pool</dt>
                        <dd class="mt-1">
                            <span class="rounded-full bg-cyan-500/20 px-3 py-1 text-xs text-cyan-200">{{ if .Server.WorkerPoolName }}{{ .Server.WorkerPoolName }}{{ else if .Server.WorkerPoolSlug }}{{ .Server.WorkerPoolSlug }}{{ else }}default{{ end }}</span>
                            <a href="{{ $.BasePath }}/pools" class="ml-2 text-xs text-cyan-200 underline">View pool policy</a>
                        </dd>
                    </div>
                    <div>
                        <dt class="text-xs uppercase tracking-wide text-slate-500">Runtime Match</dt>
                        <dd class="mt-1">
                            {{ if eq .Server.RuntimeMatchStatus "matched" }}
                                <span class="rounded-full bg-emerald-500/20 px-3 py-1 text-xs text-emerald-300">matched</span>
                                <span class="mt-1 block text-xs text-slate-500">{{ if .Server.RuntimeMatchWorkerID }}worker {{ .Server.RuntimeMatchWorkerID }}{{ else }}identity linked{{ end }}</span>
                            {{ else }}
                                <span class="rounded-full bg-amber-500/20 px-3 py-1 text-xs text-amber-200">unmatched</span>
                                <span class="mt-1 block text-xs text-slate-500">No runtime worker identity correlation yet.</span>
                            {{ end }}
                            {{ if .Server.RuntimeMatchDetail }}
                                <p class="mt-1 text-xs text-slate-500">{{ .Server.RuntimeMatchDetail }}</p>
                            {{ end }}
                        </dd>
                    </div>
                </dl>
            </section>

            <section class="rounded-xl border border-slate-800 bg-slate-950/60 p-4">
                <h3 class="text-sm font-semibold text-slate-100">Last Command</h3>
                {{ if .Server.LastCommandStatus }}
                    <div class="mt-3 space-y-2 text-sm text-slate-300">
                        <p>
                            <span class="rounded-full px-3 py-1 text-xs {{ if eq .Server.LastCommandStatus "success" }}bg-emerald-500/20 text-emerald-300{{ else if eq .Server.LastCommandStatus "failed" }}bg-red-500/20 text-red-300{{ else }}bg-amber-500/20 text-amber-200{{ end }}">{{ .Server.LastCommandStatus }}</span>
                        </p>
                        {{ if .Server.LastCommandRequestID }}
                            <p class="text-xs text-slate-500">request id: <code class="text-slate-300">{{ .Server.LastCommandRequestID }}</code></p>
                        {{ end }}
                        {{ if .Server.LastTransitionAt }}
                            <p class="text-xs text-slate-500">transition: {{ .Server.LastTransitionAt }}</p>
                        {{ end }}
                    </div>
                {{ else }}
                    <p class="mt-3 text-sm text-slate-400">No command recorded yet.</p>
                {{ end }}

                <div class="mt-4 rounded-lg border border-slate-800 bg-slate-900/70 px-3 py-2 text-xs text-slate-400">
                    <p><strong class="text-slate-200">Database sync:</strong> freshness timer from last database heartbeat.</p>
                    <p class="mt-1"><strong class="text-slate-200">Runtime match:</strong> identity mapping by worker id/ip/host, independent from freshness.</p>
                </div>
            </section>
        </div>

        <section class="mt-6 rounded-xl border border-slate-800 bg-slate-950/60 p-4">
            <h3 class="text-sm font-semibold text-slate-100">Infrastructure Control</h3>
            <p class="mt-1 text-xs text-slate-400">Start/Stop/Restart control the host worker process and are not daily runtime scheduling actions.</p>
            <p class="mt-1 text-xs text-slate-500">Use Workers page for Pause/Resume, Drain, and Quarantine (scheduler controls).</p>

            {{ if and (eq .Server.ProcessControlMode "agent_systemd") .Server.AgentEnabled }}
                <div class="mt-3 flex flex-wrap gap-2">
                    <form method="POST" action="{{ .BasePath }}/servers/{{ .Server.ID }}/command">
                        <input type="hidden" name="return_to" value="server_manage" />
                        <input type="hidden" name="return_server_id" value="{{ .Server.ID }}" />
                        <input type="hidden" name="action" value="start" />
                        <input type="hidden" name="reason" value="go-servers-manage-start" />
                        <button class="rounded-full bg-emerald-500/20 px-3 py-1 text-xs text-emerald-300 hover:bg-emerald-500/30" type="submit">Start</button>
                    </form>
                    <form method="POST" action="{{ .BasePath }}/servers/{{ .Server.ID }}/command">
                        <input type="hidden" name="return_to" value="server_manage" />
                        <input type="hidden" name="return_server_id" value="{{ .Server.ID }}" />
                        <input type="hidden" name="action" value="stop" />
                        <input type="hidden" name="reason" value="go-servers-manage-stop" />
                        <button class="rounded-full bg-red-500/20 px-3 py-1 text-xs text-red-300 hover:bg-red-500/30" type="submit">Stop</button>
                    </form>
                    <form method="POST" action="{{ .BasePath }}/servers/{{ .Server.ID }}/command">
                        <input type="hidden" name="return_to" value="server_manage" />
                        <input type="hidden" name="return_server_id" value="{{ .Server.ID }}" />
                        <input type="hidden" name="action" value="restart" />
                        <input type="hidden" name="reason" value="go-servers-manage-restart" />
                        <button class="rounded-full bg-amber-500/20 px-3 py-1 text-xs text-amber-200 hover:bg-amber-500/30" type="submit">Restart</button>
                    </form>
                    <form method="POST" action="{{ .BasePath }}/servers/{{ .Server.ID }}/command">
                        <input type="hidden" name="return_to" value="server_manage" />
                        <input type="hidden" name="return_server_id" value="{{ .Server.ID }}" />
                        <input type="hidden" name="action" value="status" />
                        <input type="hidden" name="reason" value="go-servers-manage-status" />
                        <button class="rounded-full bg-slate-800 px-3 py-1 text-xs text-slate-200 hover:bg-slate-700" type="submit">Status Check</button>
                    </form>
                </div>
            {{ else }}
                <p class="mt-3 text-xs text-amber-200">Agent process control is disabled for this server. Enable <code class="text-amber-100">agent_systemd + agent_enabled</code> in edit settings to use Start/Stop/Restart.</p>
            {{ end }}
        </section>

        <section class="mt-6 rounded-xl border border-slate-800 bg-slate-950/60 p-4">
            <h3 class="text-sm font-semibold text-slate-100">Delete Guard</h3>
            <p class="mt-1 text-xs text-slate-400">Delete is blocked while process is running/starting/stopping or Database sync is healthy.</p>
            <div class="mt-3 flex items-center gap-3">
                <form method="POST" action="{{ .BasePath }}/servers/{{ .Server.ID }}/delete" data-confirm-title="Delete Server" data-confirm-message="Delete server {{ .Server.Name }} from inventory? This does not terminate the VPS itself.">
                    <input type="hidden" name="return_to" value="servers" />
                    <input type="hidden" name="registry_filter" value="all" />
                    <button class="rounded-full bg-red-500/20 px-3 py-1 text-xs text-red-300 hover:bg-red-500/30 disabled:cursor-not-allowed disabled:opacity-40" type="submit" {{ if .DeleteLocked }}disabled{{ end }}>Delete Server</button>
                </form>
                {{ if .DeleteLocked }}
                    <span class="text-xs text-amber-200">Blocked until process is stopped and Database sync is delayed/no data.</span>
                {{ else }}
                    <span class="text-xs text-emerald-200">Eligible for delete.</span>
                {{ end }}
            </div>
        </section>
    </section>
</section>
{{ end }}
