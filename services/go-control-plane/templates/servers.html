{{ define "servers" }}
<section class="space-y-4">
    <section class="rounded-2xl border border-slate-800 bg-slate-900/60 p-6">
        <div class="flex flex-wrap items-center justify-between gap-3">
            <div class="space-y-1">
                <h2 class="text-lg font-semibold">Server Inventory</h2>
                <p class="text-sm text-slate-400">List and manage state only. Onboarding and re-provisioning are in Provisioning.</p>
                <p class="text-xs text-slate-500">Database sync freshness and runtime match explain different signals. A server can be matched but delayed.</p>
            </div>
            <a href="{{ .BasePath }}/provisioning" class="rounded-full bg-amber-500 px-4 py-2 text-xs font-semibold text-slate-900 hover:bg-amber-400">Open Provisioning Wizard</a>
        </div>

        {{ if not .ServerRegistry.Configured }}
            <div class="mt-6 rounded-xl border border-red-500/40 bg-red-500/10 px-4 py-3 text-sm text-red-200">
                Server inventory integration is unavailable. Configure <code class="text-red-100">LARAVEL_INTERNAL_API_BASE_URL</code> and <code class="text-red-100">LARAVEL_INTERNAL_API_TOKEN</code>.
            </div>
        {{ else }}
            {{ if .ServerRegistry.Notice }}
                <div class="mt-6 rounded-xl border border-emerald-500/40 bg-emerald-500/10 px-4 py-3 text-sm text-emerald-200">
                    {{ .ServerRegistry.Notice }}
                </div>
            {{ end }}
            {{ if .ServerRegistry.Error }}
                <div class="mt-6 rounded-xl border border-red-500/40 bg-red-500/10 px-4 py-3 text-sm text-red-200">
                    {{ .ServerRegistry.Error }}
                </div>
            {{ end }}
            {{ if .ServerRegistry.Warning }}
                <div class="mt-6 rounded-xl border border-amber-500/40 bg-amber-500/10 px-4 py-3 text-sm text-amber-100">
                    {{ .ServerRegistry.Warning }}
                </div>
            {{ end }}

            <div class="mt-6 flex flex-wrap items-center gap-2 text-xs">
                <span class="text-slate-400">Filter:</span>
                <a href="{{ .BasePath }}/servers?registry_filter=all" class="rounded-full px-3 py-1 {{ if eq .ServerRegistry.Filter "all" }}bg-amber-500 text-slate-900{{ else }}bg-slate-800 text-slate-300 hover:bg-slate-700{{ end }}">All</a>
                <a href="{{ .BasePath }}/servers?registry_filter=operational" class="rounded-full px-3 py-1 {{ if eq .ServerRegistry.Filter "operational" }}bg-amber-500 text-slate-900{{ else }}bg-slate-800 text-slate-300 hover:bg-slate-700{{ end }}">Operational</a>
                <a href="{{ .BasePath }}/servers?registry_filter=needs_attention" class="rounded-full px-3 py-1 {{ if eq .ServerRegistry.Filter "needs_attention" }}bg-amber-500 text-slate-900{{ else }}bg-slate-800 text-slate-300 hover:bg-slate-700{{ end }}">Needs Attention</a>
                <a href="{{ .BasePath }}/servers?registry_filter=matched" class="rounded-full px-3 py-1 {{ if eq .ServerRegistry.Filter "matched" }}bg-amber-500 text-slate-900{{ else }}bg-slate-800 text-slate-300 hover:bg-slate-700{{ end }}">Matched</a>
                <a href="{{ .BasePath }}/servers?registry_filter=unmatched" class="rounded-full px-3 py-1 {{ if eq .ServerRegistry.Filter "unmatched" }}bg-amber-500 text-slate-900{{ else }}bg-slate-800 text-slate-300 hover:bg-slate-700{{ end }}">Unmatched</a>
            </div>

            <div class="mt-4 overflow-x-auto">
                <table class="w-full text-left text-sm">
                    <thead class="text-xs uppercase text-slate-500">
                        <tr>
                            <th class="py-2">Server</th>
                            <th class="py-2">State</th>
                            <th class="py-2">Runtime Match</th>
                            <th class="py-2">Last Command</th>
                            <th class="py-2">Updated</th>
                            <th class="py-2">Actions</th>
                        </tr>
                    </thead>
                    <tbody class="divide-y divide-slate-800">
                        {{ range .ServerRegistry.Servers }}
                            <tr>
                                <td class="py-3 align-top">
                                    <p class="font-medium text-slate-100">{{ .Name }}</p>
                                    <p class="mt-1 text-xs text-slate-400">{{ .IPAddress }}{{ if or .Environment .Region }} 路 {{ if .Environment }}{{ .Environment }}{{ else }}-{{ end }} / {{ if .Region }}{{ .Region }}{{ else }}-{{ end }}{{ end }}</p>
                                    <p class="mt-1 text-xs"><span class="rounded-full bg-cyan-500/20 px-2 py-1 text-cyan-200">{{ if .WorkerPoolName }}{{ .WorkerPoolName }}{{ else if .WorkerPoolSlug }}{{ .WorkerPoolSlug }}{{ else }}default{{ end }}</span></p>
                                </td>
                                <td class="py-3 align-top">
                                    <div class="flex flex-wrap gap-2">
                                        <span class="rounded-full px-3 py-1 text-xs {{ if eq .ProcessState "running" }}bg-emerald-500/20 text-emerald-300{{ else if or (eq .ProcessState "starting") (eq .ProcessState "stopping") }}bg-amber-500/20 text-amber-200{{ else if eq .ProcessState "stopped" }}bg-red-500/20 text-red-300{{ else }}bg-slate-800 text-slate-300{{ end }}">{{ .ProcessState }}</span>
                                        <span title="Database sync freshness is derived from last database heartbeat timestamp threshold." class="rounded-full px-3 py-1 text-xs {{ if eq .HeartbeatState "healthy" }}bg-emerald-500/20 text-emerald-300{{ else if eq .HeartbeatState "stale" }}bg-amber-500/20 text-amber-200{{ else }}bg-slate-800 text-slate-300{{ end }}">{{ if eq .HeartbeatState "healthy" }}synced{{ else if eq .HeartbeatState "stale" }}delayed{{ else }}no data{{ end }}{{ if .HeartbeatAgeText }} 路 {{ .HeartbeatAgeText }}{{ end }}</span>
                                    </div>
                                    {{ if .LastHeartbeatAt }}
                                        <p class="mt-1 text-xs text-slate-500">{{ .LastHeartbeatAt }}</p>
                                    {{ end }}
                                </td>
                                <td class="py-3 align-top">
                                    {{ if eq .RuntimeMatchStatus "matched" }}
                                        <span class="rounded-full bg-emerald-500/20 px-3 py-1 text-xs text-emerald-300">matched</span>
                                        {{ if .RuntimeMatchWorkerID }}<p class="mt-1 text-xs text-slate-400">worker {{ .RuntimeMatchWorkerID }}</p>{{ end }}
                                    {{ else }}
                                        <span title="Runtime match is identity correlation (id/ip/host), not heartbeat freshness." class="rounded-full bg-amber-500/20 px-3 py-1 text-xs text-amber-200">unmatched</span>
                                    {{ end }}
                                </td>
                                <td class="py-3 align-top text-slate-300">
                                    {{ if .LastCommandStatus }}
                                        <span class="rounded-full px-3 py-1 text-xs {{ if eq .LastCommandStatus "success" }}bg-emerald-500/20 text-emerald-300{{ else if eq .LastCommandStatus "failed" }}bg-red-500/20 text-red-300{{ else }}bg-amber-500/20 text-amber-200{{ end }}">{{ .LastCommandStatus }}</span>
                                        {{ if .LastCommandRequestID }}
                                            <p class="mt-1 text-xs text-slate-500" title="request id {{ .LastCommandRequestID }}">req {{ printf "%.16s" .LastCommandRequestID }}{{ if gt (len .LastCommandRequestID) 16 }}...{{ end }}</p>
                                        {{ end }}
                                    {{ else }}
                                        <span class="text-xs text-slate-500">-</span>
                                    {{ end }}
                                </td>
                                <td class="py-3 align-top text-xs text-slate-400">{{ .UpdatedAtDisplay }}</td>
                                <td class="py-3 align-top">
                                    <a href="{{ $.BasePath }}/servers/{{ .ID }}" class="rounded-full bg-slate-800 px-3 py-1 text-xs text-slate-200 hover:bg-slate-700">Manage</a>
                                </td>
                            </tr>
                        {{ else }}
                            <tr>
                                <td class="py-6 text-center text-slate-400" colspan="6">No servers in this filter.</td>
                            </tr>
                        {{ end }}
                    </tbody>
                </table>
            </div>

            {{ if .ServerRegistry.OrphanWorkers }}
                <div class="mt-6 rounded-xl border border-amber-500/40 bg-amber-500/10 p-4">
                    <h3 class="text-sm font-semibold text-amber-100">Runtime-only workers detected</h3>
                    <p class="mt-1 text-xs text-amber-200">These runtime workers have no matching registry record yet.</p>
                    <ul class="mt-3 space-y-1 text-xs text-amber-100">
                        {{ range .ServerRegistry.OrphanWorkers }}
                            <li><code class="rounded bg-slate-900 px-2 py-1 text-amber-200">{{ .WorkerID }}</code>{{ if .Host }} 路 {{ .Host }}{{ end }}{{ if .IPAddress }} 路 {{ .IPAddress }}{{ end }}</li>
                        {{ end }}
                    </ul>
                </div>
            {{ end }}
        {{ end }}
    </section>
</section>
{{ end }}
